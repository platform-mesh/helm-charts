suite: operator
templates:
  - deployment.yaml
  - service-account.yaml
  - cluster-role.yaml
  - cluster-rolebinding.yaml
  - role.yaml
  - rolebinding.yaml
values:
  - ../test-values.yaml
chart:
  version: 1.0.0
  appVersion: 1.0.0
release:
  name: platform-mesh-operator
tests:
- it: operator match the snapshot
  set:
    deployment:
      replicas: 0
  asserts:
  - matchSnapshot: {}
- it: deployment with tracing
  template: deployment.yaml
  set:
    tracing:
      enabled: true
      collector:
        endpoint: test:4317
  asserts:
    - matchSnapshot: {}
- it: has all health checks
  template: deployment.yaml
  asserts:
    - equal:
        path: spec.template.spec.containers[0].livenessProbe.httpGet.path
        value: /healthz
    - equal:
        path: spec.template.spec.containers[0].readinessProbe.httpGet.path
        value: /readyz
    - equal:
        path: spec.template.spec.containers[0].startupProbe.httpGet.path
        value: /readyz

- it: multi-pod leader election
  template: deployment.yaml
  set:
    deployment:
      replicas: 3
    operator:
      leaderElect: true
  asserts:
    - equal:
        path: spec.replicas
        value: 3
    - equal:
        path: spec.template.spec.containers[0].args[1]
        value: "--leader-elect"

- it: enables istio sidecar injection
  template: deployment.yaml
  set:
    istio:
      enabled: true
  asserts:
    - matchSnapshot: {}
- it: disables istio sidecar injection
  template: deployment.yaml
  set:
    istio:
      enabled: false
  asserts:
    - matchSnapshot: {}
- it: configure hosAliases
  templates:
    - deployment.yaml
  set:
    hostAliases:
      enabled: true
      entries:
        - ip: "10.0.0.1"
          hostnames:
            - "example.com"
            - "test.example.com"
  asserts:
    - matchSnapshot: {}
    - equal:
        path: spec.template.spec.hostAliases[0].ip
        value: "10.0.0.1"
    - equal:
        path: spec.template.spec.hostAliases[0].hostnames[0]
        value: "example.com"
    - equal:
        path: spec.template.spec.hostAliases[0].hostnames[1]
        value: "test.example.com"
- it: deploy with extraArgs
  template: deployment.yaml
  set:
    extraArgs:
      - --custom-arg=value
      - --another-arg=anotherValue
  asserts:
    - equal:
        path: spec.template.spec.containers[0].args[?(@=="--custom-arg=value")]
        value: "--custom-arg=value"
    - equal:
        path: spec.template.spec.containers[0].args[?(@=="--another-arg=anotherValue")]
        value: "--another-arg=anotherValue"
- it: enable remote PlatformMesh and FluxCD
  template: deployment.yaml
  set:
    remoteFluxCD:
      enabled: true
      secretName: "kubeconfig-platformmesh"
      secretKey: "kubeconfig"
    remotePlatformmesh:
      enabled: true
      operator:
        secretName: "kubeconfig-deployment"
      fluxcd:
        secretName: "kubeconfig-platformmesh"
        secretKey: "kubeconfig"
  asserts:
    - matchSnapshot: {}
    - equal:
        path: spec.template.spec.containers[0].args[?(@=="--remote-fluxcd-enabled=true")]
        value: "--remote-fluxcd-enabled=true"
    - equal:
        path: spec.template.spec.containers[0].args[?(@=="--remote-fluxcd-kubeconfig=/etc/fluxcd/kubeconfig")]
        value: "--remote-fluxcd-kubeconfig=/etc/fluxcd/kubeconfig"
    - equal:
        path: spec.template.spec.containers[0].args[?(@=="--remote-platform-mesh-enabled=true")]
        value: "--remote-platform-mesh-enabled=true"
    - equal:
        path: spec.template.spec.containers[0].args[?(@=="--remote-platform-mesh-kubeconfig=/etc/platformmesh/kubeconfig")]
        value: "--remote-platform-mesh-kubeconfig=/etc/platformmesh/kubeconfig"
    - equal:
        path: spec.template.spec.containers[0].args[?(@=="--remote-platform-mesh-fluxcd-secret-name=kubeconfig-platformmesh")]
        value: "--remote-platform-mesh-fluxcd-secret-name=kubeconfig-platformmesh"
    - equal:
        path: spec.template.spec.containers[0].args[?(@=="--remote-platform-mesh-fluxcd-secret-key=kubeconfig")]
        value: "--remote-platform-mesh-fluxcd-secret-key=kubeconfig"
- it: enable remote PlatformMesh and local FluxCD
  template: deployment.yaml
  set:
    remoteFluxCD:
      enabled: false
    remotePlatformmesh:
      enabled: true
      operator:
        secretName: "kubeconfig-deployment"
        secretKey: "kubeconfig"
      fluxcd:
        secretName: "kubeconfig-platformmesh"
  asserts:
    - equal:
        path: spec.template.spec.containers[0].args[?(@=="--remote-fluxcd-enabled=false")]
        value: "--remote-fluxcd-enabled=false"
    - equal:
        path: spec.template.spec.containers[0].args[?(@=="--remote-platform-mesh-enabled=true")]
        value: "--remote-platform-mesh-enabled=true"
    - equal:
        path: spec.template.spec.containers[0].args[?(@=="--remote-platform-mesh-kubeconfig=/etc/platformmesh/kubeconfig")]
        value: "--remote-platform-mesh-kubeconfig=/etc/platformmesh/kubeconfig"
    - equal:
        path: spec.template.spec.containers[0].args[?(@=="--remote-platform-mesh-fluxcd-secret-name=kubeconfig-platformmesh")]
        value: "--remote-platform-mesh-fluxcd-secret-name=kubeconfig-platformmesh"
    - notFailedTemplate: {}
