apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
kind: ClientScope
metadata:
  name: trusted-platform-mesh-audiences
spec:
  forProvider:
    includeInTokenScope: true
    name: trusted-platform-mesh-audiences
    realmIdRef:
      name: {{ .Values.keycloak.crossplane.realm.name }}
  providerConfigRef:
    name: {{ .Values.keycloak.crossplane.providerConfig.name }}

---

{{- range $i, $val := .Values.keycloak.crossplane.trustedAudiences }}
apiVersion: client.keycloak.crossplane.io/v1alpha1
kind: ProtocolMapper
metadata:
  name: {{ $val }}-trust
spec:
  forProvider:
    name: {{ $val }}-trust
    clientScopeIdRef:
      name: trusted-platform-mesh-audiences
    protocol: openid-connect
    protocolMapper: oidc-audience-mapper
    config:
      "included.custom.audience": "{{ $val }}"
      "id.token.claim": "true"
      "lightweight.claim": "false"
      "introspection.token.claim": "true"
      "access.token.claim": "true"
      "userinfo.token.claim": "true"
    realmIdRef:
      name: {{ $.Values.keycloak.crossplane.realm.name }}
  providerConfigRef:
    name: {{ $.Values.keycloak.crossplane.providerConfig.name }}

---
{{ end -}}
