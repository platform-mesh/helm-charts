{{- if eq (include "common.getNestedValue" (dict "Values" .Values "key" "crossplane.enabled")) "true" -}}
{{- if not .Values.externalSecrets.enabled }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.keycloak.crossplane.providerConfig.name }}-secret-creator
  namespace: {{ .Values.keycloak.crossplane.providerConfig.namespace }}
{{- if ne .Values.keycloak.crossplane.providerConfig.namespace "platform-mesh-system" }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ .Values.keycloak.crossplane.providerConfig.name }}-secret-reader
  namespace: platform-mesh-system
rules:
- apiGroups: [""]
  resources: ["secrets"]
  resourceNames: ["keycloak-admin"]
  verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ .Values.keycloak.crossplane.providerConfig.name }}-secret-reader
  namespace: platform-mesh-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ .Values.keycloak.crossplane.providerConfig.name }}-secret-reader
subjects:
- kind: ServiceAccount
  name: {{ .Values.keycloak.crossplane.providerConfig.name }}-secret-creator
  namespace: {{ .Values.keycloak.crossplane.providerConfig.namespace }}
{{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ .Values.keycloak.crossplane.providerConfig.name }}-secret-creator
  namespace: {{ .Values.keycloak.crossplane.providerConfig.namespace }}
rules:
{{- if eq .Values.keycloak.crossplane.providerConfig.namespace "platform-mesh-system" }}
- apiGroups: [""]
  resources: ["secrets"]
  resourceNames: ["keycloak-admin"]
  verbs: ["get"]
{{- end }}
- apiGroups: [""]
  resources: ["secrets"]
  resourceNames: ["{{ .Values.keycloak.crossplane.providerConfig.name }}"]
  verbs: ["get", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ .Values.keycloak.crossplane.providerConfig.name }}-secret-creator
  namespace: {{ .Values.keycloak.crossplane.providerConfig.namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ .Values.keycloak.crossplane.providerConfig.name }}-secret-creator
subjects:
- kind: ServiceAccount
  name: {{ .Values.keycloak.crossplane.providerConfig.name }}-secret-creator
  namespace: {{ .Values.keycloak.crossplane.providerConfig.namespace }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.keycloak.crossplane.providerConfig.name }}-secret-creator
  namespace: {{ .Values.keycloak.crossplane.providerConfig.namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      name: {{ .Values.keycloak.crossplane.providerConfig.name }}-secret-creator
    spec:
      serviceAccountName: {{ .Values.keycloak.crossplane.providerConfig.name }}-secret-creator
      restartPolicy: OnFailure
      containers:
      - name: secret-creator
        # image: bitnami/kubectl:latest
        image: ghcr.io/platform-mesh/images/ocmbuilder:pr-4
        command:
        - /bin/sh
        - -c
        - |
          set -e
          
          # Read the keycloak-admin secret
          echo "Reading keycloak-admin secret..."
          ADMIN_SECRET=$(kubectl get secret keycloak-admin -n platform-mesh-system -o jsonpath='{.data.secret}' 2>/dev/null || echo "")
          
          if [ -z "$ADMIN_SECRET" ]; then
            echo "Warning: keycloak-admin secret not found or secret key missing, using default password"
            PASSWORD="aesaeXaefu0x"
          else
            # Decode base64 password
            PASSWORD=$(echo "$ADMIN_SECRET" | base64 -d)
          fi
          
          # Escape password for JSON (escape backslashes, quotes, and newlines)
          ESCAPED_PASSWORD=$(echo -n "$PASSWORD" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          
          # Create the provider config JSON using printf to avoid shell expansion issues
          CONFIG_JSON=$(printf '{"client_id":"admin-cli","username":"{{ .Values.keycloak.keycloakConfig.admin.username.value }}","password":"%s","url":"{{ .Values.keycloak.keycloakConfig.url }}","realm":"master"}' "$ESCAPED_PASSWORD")
          
          # Check if secret already exists
          if kubectl get secret {{ .Values.keycloak.crossplane.providerConfig.name }} -n {{ .Values.keycloak.crossplane.providerConfig.namespace }} &>/dev/null; then
            echo "Updating existing secret {{ .Values.keycloak.crossplane.providerConfig.name }}..."
            # Delete and recreate to ensure clean state
            kubectl delete secret {{ .Values.keycloak.crossplane.providerConfig.name }} -n {{ .Values.keycloak.crossplane.providerConfig.namespace }} --ignore-not-found=true
          fi
          
          echo "Creating secret {{ .Values.keycloak.crossplane.providerConfig.name }}..."
          kubectl create secret generic {{ .Values.keycloak.crossplane.providerConfig.name }} \
            --from-literal=config="$CONFIG_JSON" \
            -n {{ .Values.keycloak.crossplane.providerConfig.namespace }}
          
          echo "Secret {{ .Values.keycloak.crossplane.providerConfig.name }} created/updated successfully"
{{- end -}}
{{- end -}}
