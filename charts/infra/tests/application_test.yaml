# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Test the application manifests
release:
  name: infra
  namespace: platform-mesh-system
tests:
- it: match snapshots
  set:
    kcp:
      image:
        tag: 0.0.0
  asserts:
  - matchSnapshot: {}
- it: match snapshots w. hostAliases enabled
  set:
    kcp:
      frontProxy:
        clusterIP: "10.0.0.1"
    hostAliases:
      enabled: true
  asserts:
    - matchSnapshot: {}
- it: match snapshots w. kcp version
  set:
    kcp:
      image:
        tag: "v0.1.0"
  asserts:
    - matchSnapshot: {}
- it: match snapshots with mailpit enabled
  set:
    mailpit:
      enabled: true
  asserts:
  - matchSnapshot: {}
- it: Gateway API enabled
  set:
    gatewayApi:
      enabled: true
    cors:
      enabled: true
  asserts:
    - matchSnapshot: {}
- it: Istio disabled
  set:
    istio:
      enabled: false
  asserts:
    - matchSnapshot: {}
- it: Istio enabled
  set:
    istio:
      enabled: true
  asserts:
    - matchSnapshot: {}
- it: configure gateway TLS credential namespace
  templates:
    - gatewayapi/gateway.yaml
  set:
    gatewayApi:
      enabled: true
      listeners:
        - name: terminate
          hostname: portal.localhost
          port: 8443
          protocol: HTTPS
          tls:
            mode: Terminate
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: default2
  asserts:
  - equal:
      path: spec.listeners[0].tls.certificateRefs[0].namespace
      value: default2
- it: configure frontproxy resources
  templates:
    - kcp/front-proxy.yaml
  set:
    kcp:
      frontProxy:
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 128Mi
  asserts:
  - matchSnapshot: {}
- it: configure rootshard resources
  templates:
    - kcp/root-shard.yaml
  set:
    kcp:
      rootShard:
        resources:
          limits:
            cpu: 1000m
            memory: 1Gi
          requests:
            cpu: 200m
            memory: 256Mi
  asserts:
  - matchSnapshot: {}
- it: configure etcd backup store
  templates:
    - kcp/etcd.yaml
  set:
    kcp:
      etcd:
        backup:
          store:
            container: etcd-bucket
            prefix: etcd-test
            provider: S3
            endpointOverride: http://localstack.default:4566
            secretRef:
              name: etcd-backup-aws
  asserts:
  - equal:
      path: spec.backup.store
      value:
        container: etcd-bucket
        prefix: etcd-test
        provider: S3
        endpointOverride: http://localstack.default:4566
        secretRef:
          name: etcd-backup-aws
  - matchSnapshot: {}
