match snapshots:
  1: |
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: kcp-cluster-admin-client-cert
      namespace: platform-mesh-system
    spec:
      commonName: cluster-admin
      issuerRef:
        name: root-front-proxy-client-ca
      privateKey:
        algorithm: RSA
        size: 2048
      secretName: kcp-cluster-admin-client-cert
      subject:
        organizations:
          - system:kcp:admin
      usages:
        - client auth
  2: |
    apiVersion: druid.gardener.cloud/v1alpha1
    kind: Etcd
    metadata:
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      name: etcd-kcp
      namespace: platform-mesh-system
    spec:
      annotations:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      backup:
        compression:
          enabled: false
          policy: gzip
        deltaSnapshotMemoryLimit: 1Gi
        deltaSnapshotPeriod: 300s
        fullSnapshotSchedule: 0 */24 * * *
        garbageCollectionPeriod: 43200s
        garbageCollectionPolicy: Exponential
        leaderElection:
          etcdConnectionTimeout: 5s
          reelectionPeriod: 5s
        port: 8080
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 23m
            memory: 128Mi
      etcd:
        clientPort: 2379
        defragmentationSchedule: 0 */24 * * *
        metrics: basic
        quota: 8Gi
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 200Mi
        serverPort: 2380
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      replicas: 1
      sharedConfig:
        autoCompactionMode: periodic
        autoCompactionRetention: 30m
  3: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: FrontProxy
    metadata:
      name: frontproxy
      namespace: platform-mesh-system
    spec:
      additionalPathMappings:
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/contentconfigurations
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/marketplace
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
      auth:
        oidc:
          clientID: default
          enabled: true
          groupsClaim: groups
          issuerURL: https://portal.dev.local:8443/keycloak/realms/default
          usernameClaim: email
      rootShard:
        ref:
          name: root
      serviceTemplate:
        spec:
          ports:
            - appProtocol: https
              name: https
              port: 8443
              protocol: TCP
              targetPort: 6443
          type: ClusterIP
  4: |
    apiVersion: cert-manager.io/v1
    kind: Issuer
    metadata:
      name: selfsigned
      namespace: platform-mesh-system
    spec:
      selfSigned: {}
  5: |
    apiVersion: networking.istio.io/v1beta1
    kind: Gateway
    metadata:
      name: infra-tls-passthrough
      namespace: platform-mesh-system
    spec:
      selector:
        istio: gateway
      servers:
        - hosts:
            - kcp.api.portal.dev.local
          port:
            name: https
            number: 8443
            protocol: HTTPS
          tls:
            mode: PASSTHROUGH
  6: |
    apiVersion: networking.istio.io/v1beta1
    kind: VirtualService
    metadata:
      name: infra
      namespace: platform-mesh-system
    spec:
      gateways:
        - platform-mesh-system/infra-tls-passthrough
      hosts:
        - kcp.api.portal.dev.local
      tls:
        - match:
            - sniHosts:
                - kcp.api.portal.dev.local
          route:
            - destination:
                host: frontproxy-front-proxy.platform-mesh-system.svc.cluster.local
  7: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: RootShard
    metadata:
      name: root
      namespace: platform-mesh-system
    spec:
      cache:
        embedded:
          enabled: true
      certificates:
        issuerRef:
          group: cert-manager.io
          kind: Issuer
          name: selfsigned
      etcd:
        endpoints:
          - http://etcd-kcp-client.platform-mesh-system.svc.cluster.local:2379
      external:
        hostname: kcp.api.portal.dev.local
        port: 8443
match snapshots w. hostAliases enabled:
  1: |
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: kcp-cluster-admin-client-cert
      namespace: platform-mesh-system
    spec:
      commonName: cluster-admin
      issuerRef:
        name: root-front-proxy-client-ca
      privateKey:
        algorithm: RSA
        size: 2048
      secretName: kcp-cluster-admin-client-cert
      subject:
        organizations:
          - system:kcp:admin
      usages:
        - client auth
  2: |
    apiVersion: druid.gardener.cloud/v1alpha1
    kind: Etcd
    metadata:
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      name: etcd-kcp
      namespace: platform-mesh-system
    spec:
      annotations:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      backup:
        compression:
          enabled: false
          policy: gzip
        deltaSnapshotMemoryLimit: 1Gi
        deltaSnapshotPeriod: 300s
        fullSnapshotSchedule: 0 */24 * * *
        garbageCollectionPeriod: 43200s
        garbageCollectionPolicy: Exponential
        leaderElection:
          etcdConnectionTimeout: 5s
          reelectionPeriod: 5s
        port: 8080
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 23m
            memory: 128Mi
      etcd:
        clientPort: 2379
        defragmentationSchedule: 0 */24 * * *
        metrics: basic
        quota: 8Gi
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 200Mi
        serverPort: 2380
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      replicas: 1
      sharedConfig:
        autoCompactionMode: periodic
        autoCompactionRetention: 30m
  3: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: FrontProxy
    metadata:
      name: frontproxy
      namespace: platform-mesh-system
    spec:
      additionalPathMappings:
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/contentconfigurations
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/marketplace
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
      auth:
        oidc:
          clientID: default
          enabled: true
          groupsClaim: groups
          issuerURL: https://portal.dev.local:8443/keycloak/realms/default
          usernameClaim: email
      deploymentTemplate:
        spec:
          template:
            spec:
              hostAliases:
                - hostnames:
                    - kcp.api.portal.dev.local
                  ip: 10.96.188.4
      rootShard:
        ref:
          name: root
      serviceTemplate:
        spec:
          clusterIP: 10.0.0.1
          ports:
            - appProtocol: https
              name: https
              port: 8443
              protocol: TCP
              targetPort: 6443
          type: ClusterIP
  4: |
    apiVersion: cert-manager.io/v1
    kind: Issuer
    metadata:
      name: selfsigned
      namespace: platform-mesh-system
    spec:
      selfSigned: {}
  5: |
    apiVersion: networking.istio.io/v1beta1
    kind: Gateway
    metadata:
      name: infra-tls-passthrough
      namespace: platform-mesh-system
    spec:
      selector:
        istio: gateway
      servers:
        - hosts:
            - kcp.api.portal.dev.local
          port:
            name: https
            number: 8443
            protocol: HTTPS
          tls:
            mode: PASSTHROUGH
  6: |
    apiVersion: networking.istio.io/v1beta1
    kind: VirtualService
    metadata:
      name: infra
      namespace: platform-mesh-system
    spec:
      gateways:
        - platform-mesh-system/infra-tls-passthrough
      hosts:
        - kcp.api.portal.dev.local
      tls:
        - match:
            - sniHosts:
                - kcp.api.portal.dev.local
          route:
            - destination:
                host: frontproxy-front-proxy.platform-mesh-system.svc.cluster.local
  7: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: RootShard
    metadata:
      name: root
      namespace: platform-mesh-system
    spec:
      cache:
        embedded:
          enabled: true
      certificates:
        issuerRef:
          group: cert-manager.io
          kind: Issuer
          name: selfsigned
      deploymentTemplate:
        spec:
          template:
            spec:
              hostAliases:
                - hostnames:
                    - kcp.api.portal.dev.local
                  ip: 10.96.188.4
      etcd:
        endpoints:
          - http://etcd-kcp-client.platform-mesh-system.svc.cluster.local:2379
      external:
        hostname: kcp.api.portal.dev.local
        port: 8443
