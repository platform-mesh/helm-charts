Gateway API enabled:
  1: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: Gateway
    metadata:
      name: k8sapi-gateway
      namespace: platform-mesh-system
    spec:
      gatewayClassName: traefik
      listeners:
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: portal.localhost
          name: websecure
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: '*.portal.localhost'
          name: websecure-wildcard-portal-localhost
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: TLSRoute
            namespaces:
              from: All
          hostname: localhost
          name: https-passthrough
          port: 8443
          protocol: TLS
          tls:
            mode: Passthrough
  2: |
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: kcp-cluster-admin-client-cert
      namespace: platform-mesh-system
    spec:
      commonName: cluster-admin
      issuerRef:
        name: root-front-proxy-client-ca
      privateKey:
        algorithm: RSA
        size: 2048
      secretName: kcp-cluster-admin-client-cert
      subject:
        organizations:
          - system:kcp:admin
      usages:
        - client auth
  3: |
    apiVersion: druid.gardener.cloud/v1alpha1
    kind: Etcd
    metadata:
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      name: etcd-kcp
      namespace: platform-mesh-system
    spec:
      annotations:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      backup:
        compression:
          enabled: false
          policy: gzip
        deltaSnapshotMemoryLimit: 1Gi
        deltaSnapshotPeriod: 300s
        fullSnapshotSchedule: 0 */24 * * *
        garbageCollectionPeriod: 43200s
        garbageCollectionPolicy: Exponential
        leaderElection:
          etcdConnectionTimeout: 5s
          reelectionPeriod: 5s
        port: 8080
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 23m
            memory: 128Mi
      etcd:
        clientPort: 2379
        defragmentationSchedule: 0 */24 * * *
        metrics: basic
        quota: 8Gi
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 200Mi
        serverPort: 2380
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      replicas: 1
      sharedConfig:
        autoCompactionMode: periodic
        autoCompactionRetention: 30m
  4: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: FrontProxy
    metadata:
      name: frontproxy
      namespace: platform-mesh-system
    spec:
      additionalPathMappings:
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/contentconfigurations
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/marketplace
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
      rootShard:
        ref:
          name: root
      serviceTemplate:
        spec:
          ports:
            - appProtocol: https
              name: https
              port: 8443
              protocol: TCP
              targetPort: 6443
          type: ClusterIP
  5: |
    apiVersion: cert-manager.io/v1
    kind: Issuer
    metadata:
      name: selfsigned
      namespace: platform-mesh-system
    spec:
      selfSigned: {}
  6: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: RootShard
    metadata:
      name: root
      namespace: platform-mesh-system
    spec:
      authorization:
        webhook:
          configSecretName: kcp-webhook-secret
      cache:
        embedded:
          enabled: true
      certificates:
        issuerRef:
          group: cert-manager.io
          kind: Issuer
          name: selfsigned
      deploymentTemplate:
        spec:
          template:
            metadata:
              annotations:
                traffic.sidecar.istio.io/excludeOutboundPorts: "9443"
            spec: null
      etcd:
        endpoints:
          - http://etcd-kcp-client.platform-mesh-system.svc.cluster.local:2379
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
  7: |
    apiVersion: gateway.networking.k8s.io/v1alpha2
    kind: TLSRoute
    metadata:
      name: kcp-front-proxy-tlsroute
    spec:
      hostnames:
        - localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: https-passthrough
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: frontproxy-front-proxy
              port: 6443
              weight: 1
          name: https-passthrough
  8: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: keycloak
    spec:
      hostnames:
        - portal.localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: keycloak
              namespace: platform-mesh-system
              port: 80
          filters:
            - extensionRef:
                group: traefik.io
                kind: Middleware
                name: cors-header
              type: ExtensionRef
          matches:
            - path:
                type: PathPrefix
                value: /keycloak
  9: |
    apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: cors-header
      namespace: platform-mesh-system
    spec:
      headers:
        accessControlAllowCredentials: true
        accessControlAllowHeaders:
          - '*'
        accessControlAllowMethods:
          - GET
          - OPTIONS
          - POST
        accessControlMaxAge: 100
        addVaryHeader: true
Istio disabled:
  1: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: Gateway
    metadata:
      name: k8sapi-gateway
      namespace: platform-mesh-system
    spec:
      gatewayClassName: traefik
      listeners:
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: portal.localhost
          name: websecure
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: '*.portal.localhost'
          name: websecure-wildcard-portal-localhost
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: TLSRoute
            namespaces:
              from: All
          hostname: localhost
          name: https-passthrough
          port: 8443
          protocol: TLS
          tls:
            mode: Passthrough
  2: |
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: kcp-cluster-admin-client-cert
      namespace: platform-mesh-system
    spec:
      commonName: cluster-admin
      issuerRef:
        name: root-front-proxy-client-ca
      privateKey:
        algorithm: RSA
        size: 2048
      secretName: kcp-cluster-admin-client-cert
      subject:
        organizations:
          - system:kcp:admin
      usages:
        - client auth
  3: |
    apiVersion: druid.gardener.cloud/v1alpha1
    kind: Etcd
    metadata:
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      name: etcd-kcp
      namespace: platform-mesh-system
    spec:
      annotations:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      backup:
        compression:
          enabled: false
          policy: gzip
        deltaSnapshotMemoryLimit: 1Gi
        deltaSnapshotPeriod: 300s
        fullSnapshotSchedule: 0 */24 * * *
        garbageCollectionPeriod: 43200s
        garbageCollectionPolicy: Exponential
        leaderElection:
          etcdConnectionTimeout: 5s
          reelectionPeriod: 5s
        port: 8080
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 23m
            memory: 128Mi
      etcd:
        clientPort: 2379
        defragmentationSchedule: 0 */24 * * *
        metrics: basic
        quota: 8Gi
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 200Mi
        serverPort: 2380
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      replicas: 1
      sharedConfig:
        autoCompactionMode: periodic
        autoCompactionRetention: 30m
  4: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: FrontProxy
    metadata:
      name: frontproxy
      namespace: platform-mesh-system
    spec:
      additionalPathMappings:
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/contentconfigurations
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/marketplace
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
      rootShard:
        ref:
          name: root
      serviceTemplate:
        spec:
          ports:
            - appProtocol: https
              name: https
              port: 8443
              protocol: TCP
              targetPort: 6443
          type: ClusterIP
  5: |
    apiVersion: cert-manager.io/v1
    kind: Issuer
    metadata:
      name: selfsigned
      namespace: platform-mesh-system
    spec:
      selfSigned: {}
  6: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: RootShard
    metadata:
      name: root
      namespace: platform-mesh-system
    spec:
      authorization:
        webhook:
          configSecretName: kcp-webhook-secret
      cache:
        embedded:
          enabled: true
      certificates:
        issuerRef:
          group: cert-manager.io
          kind: Issuer
          name: selfsigned
      deploymentTemplate:
        spec:
          template:
            metadata:
              annotations:
                traffic.sidecar.istio.io/excludeOutboundPorts: "9443"
            spec: null
      etcd:
        endpoints:
          - http://etcd-kcp-client.platform-mesh-system.svc.cluster.local:2379
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
  7: |
    apiVersion: gateway.networking.k8s.io/v1alpha2
    kind: TLSRoute
    metadata:
      name: kcp-front-proxy-tlsroute
    spec:
      hostnames:
        - localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: https-passthrough
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: frontproxy-front-proxy
              port: 6443
              weight: 1
          name: https-passthrough
  8: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: keycloak
    spec:
      hostnames:
        - portal.localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: keycloak
              namespace: platform-mesh-system
              port: 80
          filters:
            - extensionRef:
                group: traefik.io
                kind: Middleware
                name: cors-header
              type: ExtensionRef
          matches:
            - path:
                type: PathPrefix
                value: /keycloak
  9: |
    apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: cors-header
      namespace: platform-mesh-system
    spec:
      headers:
        accessControlAllowCredentials: true
        accessControlAllowHeaders:
          - '*'
        accessControlAllowMethods:
          - GET
          - OPTIONS
          - POST
        accessControlMaxAge: 100
        addVaryHeader: true
Istio enabled:
  1: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: Gateway
    metadata:
      name: k8sapi-gateway
      namespace: platform-mesh-system
    spec:
      gatewayClassName: traefik
      listeners:
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: portal.localhost
          name: websecure
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: '*.portal.localhost'
          name: websecure-wildcard-portal-localhost
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: TLSRoute
            namespaces:
              from: All
          hostname: localhost
          name: https-passthrough
          port: 8443
          protocol: TLS
          tls:
            mode: Passthrough
  2: |
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: kcp-cluster-admin-client-cert
      namespace: platform-mesh-system
    spec:
      commonName: cluster-admin
      issuerRef:
        name: root-front-proxy-client-ca
      privateKey:
        algorithm: RSA
        size: 2048
      secretName: kcp-cluster-admin-client-cert
      subject:
        organizations:
          - system:kcp:admin
      usages:
        - client auth
  3: |
    apiVersion: druid.gardener.cloud/v1alpha1
    kind: Etcd
    metadata:
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      name: etcd-kcp
      namespace: platform-mesh-system
    spec:
      annotations:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      backup:
        compression:
          enabled: false
          policy: gzip
        deltaSnapshotMemoryLimit: 1Gi
        deltaSnapshotPeriod: 300s
        fullSnapshotSchedule: 0 */24 * * *
        garbageCollectionPeriod: 43200s
        garbageCollectionPolicy: Exponential
        leaderElection:
          etcdConnectionTimeout: 5s
          reelectionPeriod: 5s
        port: 8080
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 23m
            memory: 128Mi
      etcd:
        clientPort: 2379
        defragmentationSchedule: 0 */24 * * *
        metrics: basic
        quota: 8Gi
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 200Mi
        serverPort: 2380
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      replicas: 1
      sharedConfig:
        autoCompactionMode: periodic
        autoCompactionRetention: 30m
  4: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: FrontProxy
    metadata:
      name: frontproxy
      namespace: platform-mesh-system
    spec:
      additionalPathMappings:
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/contentconfigurations
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/marketplace
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
      rootShard:
        ref:
          name: root
      serviceTemplate:
        spec:
          ports:
            - appProtocol: https
              name: https
              port: 8443
              protocol: TCP
              targetPort: 6443
          type: ClusterIP
  5: |
    apiVersion: cert-manager.io/v1
    kind: Issuer
    metadata:
      name: selfsigned
      namespace: platform-mesh-system
    spec:
      selfSigned: {}
  6: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: RootShard
    metadata:
      name: root
      namespace: platform-mesh-system
    spec:
      authorization:
        webhook:
          configSecretName: kcp-webhook-secret
      cache:
        embedded:
          enabled: true
      certificates:
        issuerRef:
          group: cert-manager.io
          kind: Issuer
          name: selfsigned
      deploymentTemplate:
        spec:
          template:
            metadata:
              annotations:
                traffic.sidecar.istio.io/excludeOutboundPorts: "9443"
            spec: null
      etcd:
        endpoints:
          - http://etcd-kcp-client.platform-mesh-system.svc.cluster.local:2379
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
  7: |
    apiVersion: gateway.networking.k8s.io/v1alpha2
    kind: TLSRoute
    metadata:
      name: kcp-front-proxy-tlsroute
    spec:
      hostnames:
        - localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: https-passthrough
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: frontproxy-front-proxy
              port: 6443
              weight: 1
          name: https-passthrough
  8: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: keycloak
    spec:
      hostnames:
        - portal.localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: keycloak
              namespace: platform-mesh-system
              port: 80
          filters:
            - extensionRef:
                group: traefik.io
                kind: Middleware
                name: cors-header
              type: ExtensionRef
          matches:
            - path:
                type: PathPrefix
                value: /keycloak
  9: |
    apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: cors-header
      namespace: platform-mesh-system
    spec:
      headers:
        accessControlAllowCredentials: true
        accessControlAllowHeaders:
          - '*'
        accessControlAllowMethods:
          - GET
          - OPTIONS
          - POST
        accessControlMaxAge: 100
        addVaryHeader: true
match snapshots:
  1: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: Gateway
    metadata:
      name: k8sapi-gateway
      namespace: platform-mesh-system
    spec:
      gatewayClassName: traefik
      listeners:
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: portal.localhost
          name: websecure
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: '*.portal.localhost'
          name: websecure-wildcard-portal-localhost
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: TLSRoute
            namespaces:
              from: All
          hostname: localhost
          name: https-passthrough
          port: 8443
          protocol: TLS
          tls:
            mode: Passthrough
  2: |
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: kcp-cluster-admin-client-cert
      namespace: platform-mesh-system
    spec:
      commonName: cluster-admin
      issuerRef:
        name: root-front-proxy-client-ca
      privateKey:
        algorithm: RSA
        size: 2048
      secretName: kcp-cluster-admin-client-cert
      subject:
        organizations:
          - system:kcp:admin
      usages:
        - client auth
  3: |
    apiVersion: druid.gardener.cloud/v1alpha1
    kind: Etcd
    metadata:
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      name: etcd-kcp
      namespace: platform-mesh-system
    spec:
      annotations:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      backup:
        compression:
          enabled: false
          policy: gzip
        deltaSnapshotMemoryLimit: 1Gi
        deltaSnapshotPeriod: 300s
        fullSnapshotSchedule: 0 */24 * * *
        garbageCollectionPeriod: 43200s
        garbageCollectionPolicy: Exponential
        leaderElection:
          etcdConnectionTimeout: 5s
          reelectionPeriod: 5s
        port: 8080
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 23m
            memory: 128Mi
      etcd:
        clientPort: 2379
        defragmentationSchedule: 0 */24 * * *
        metrics: basic
        quota: 8Gi
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 200Mi
        serverPort: 2380
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      replicas: 1
      sharedConfig:
        autoCompactionMode: periodic
        autoCompactionRetention: 30m
  4: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: FrontProxy
    metadata:
      name: frontproxy
      namespace: platform-mesh-system
    spec:
      additionalPathMappings:
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/contentconfigurations
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/marketplace
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      image:
        tag: 0.0.0
      replicas: 1
      rootShard:
        ref:
          name: root
      serviceTemplate:
        spec:
          ports:
            - appProtocol: https
              name: https
              port: 8443
              protocol: TCP
              targetPort: 6443
          type: ClusterIP
  5: |
    apiVersion: cert-manager.io/v1
    kind: Issuer
    metadata:
      name: selfsigned
      namespace: platform-mesh-system
    spec:
      selfSigned: {}
  6: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: RootShard
    metadata:
      name: root
      namespace: platform-mesh-system
    spec:
      authorization:
        webhook:
          configSecretName: kcp-webhook-secret
      cache:
        embedded:
          enabled: true
      certificates:
        issuerRef:
          group: cert-manager.io
          kind: Issuer
          name: selfsigned
      deploymentTemplate:
        spec:
          template:
            metadata:
              annotations:
                traffic.sidecar.istio.io/excludeOutboundPorts: "9443"
            spec: null
      etcd:
        endpoints:
          - http://etcd-kcp-client.platform-mesh-system.svc.cluster.local:2379
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      image:
        tag: 0.0.0
      proxy:
        image:
          tag: 0.0.0
      replicas: 1
  7: |
    apiVersion: gateway.networking.k8s.io/v1alpha2
    kind: TLSRoute
    metadata:
      name: kcp-front-proxy-tlsroute
    spec:
      hostnames:
        - localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: https-passthrough
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: frontproxy-front-proxy
              port: 6443
              weight: 1
          name: https-passthrough
  8: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: keycloak
    spec:
      hostnames:
        - portal.localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: keycloak
              namespace: platform-mesh-system
              port: 80
          filters:
            - extensionRef:
                group: traefik.io
                kind: Middleware
                name: cors-header
              type: ExtensionRef
          matches:
            - path:
                type: PathPrefix
                value: /keycloak
  9: |
    apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: cors-header
      namespace: platform-mesh-system
    spec:
      headers:
        accessControlAllowCredentials: true
        accessControlAllowHeaders:
          - '*'
        accessControlAllowMethods:
          - GET
          - OPTIONS
          - POST
        accessControlMaxAge: 100
        addVaryHeader: true
match snapshots w. hostAliases enabled:
  1: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: Gateway
    metadata:
      name: k8sapi-gateway
      namespace: platform-mesh-system
    spec:
      gatewayClassName: traefik
      listeners:
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: portal.localhost
          name: websecure
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: '*.portal.localhost'
          name: websecure-wildcard-portal-localhost
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: TLSRoute
            namespaces:
              from: All
          hostname: localhost
          name: https-passthrough
          port: 8443
          protocol: TLS
          tls:
            mode: Passthrough
  2: |
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: kcp-cluster-admin-client-cert
      namespace: platform-mesh-system
    spec:
      commonName: cluster-admin
      issuerRef:
        name: root-front-proxy-client-ca
      privateKey:
        algorithm: RSA
        size: 2048
      secretName: kcp-cluster-admin-client-cert
      subject:
        organizations:
          - system:kcp:admin
      usages:
        - client auth
  3: |
    apiVersion: druid.gardener.cloud/v1alpha1
    kind: Etcd
    metadata:
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      name: etcd-kcp
      namespace: platform-mesh-system
    spec:
      annotations:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      backup:
        compression:
          enabled: false
          policy: gzip
        deltaSnapshotMemoryLimit: 1Gi
        deltaSnapshotPeriod: 300s
        fullSnapshotSchedule: 0 */24 * * *
        garbageCollectionPeriod: 43200s
        garbageCollectionPolicy: Exponential
        leaderElection:
          etcdConnectionTimeout: 5s
          reelectionPeriod: 5s
        port: 8080
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 23m
            memory: 128Mi
      etcd:
        clientPort: 2379
        defragmentationSchedule: 0 */24 * * *
        metrics: basic
        quota: 8Gi
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 200Mi
        serverPort: 2380
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      replicas: 1
      sharedConfig:
        autoCompactionMode: periodic
        autoCompactionRetention: 30m
  4: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: FrontProxy
    metadata:
      name: frontproxy
      namespace: platform-mesh-system
    spec:
      additionalPathMappings:
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/contentconfigurations
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/marketplace
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
      deploymentTemplate:
        spec:
          template:
            spec:
              hostAliases:
                - hostnames:
                    - localhost
                    - portal.localhost
                  ip: 10.96.188.4
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
      rootShard:
        ref:
          name: root
      serviceTemplate:
        spec:
          clusterIP: 10.0.0.1
          ports:
            - appProtocol: https
              name: https
              port: 8443
              protocol: TCP
              targetPort: 6443
          type: ClusterIP
  5: |
    apiVersion: cert-manager.io/v1
    kind: Issuer
    metadata:
      name: selfsigned
      namespace: platform-mesh-system
    spec:
      selfSigned: {}
  6: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: RootShard
    metadata:
      name: root
      namespace: platform-mesh-system
    spec:
      authorization:
        webhook:
          configSecretName: kcp-webhook-secret
      cache:
        embedded:
          enabled: true
      certificates:
        issuerRef:
          group: cert-manager.io
          kind: Issuer
          name: selfsigned
      deploymentTemplate:
        spec:
          template:
            metadata:
              annotations:
                traffic.sidecar.istio.io/excludeOutboundPorts: "9443"
            spec:
              hostAliases:
                - hostnames:
                    - localhost
                    - portal.localhost
                  ip: 10.96.188.4
      etcd:
        endpoints:
          - http://etcd-kcp-client.platform-mesh-system.svc.cluster.local:2379
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
  7: |
    apiVersion: gateway.networking.k8s.io/v1alpha2
    kind: TLSRoute
    metadata:
      name: kcp-front-proxy-tlsroute
    spec:
      hostnames:
        - localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: https-passthrough
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: frontproxy-front-proxy
              port: 6443
              weight: 1
          name: https-passthrough
  8: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: keycloak
    spec:
      hostnames:
        - portal.localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: keycloak
              namespace: platform-mesh-system
              port: 80
          filters:
            - extensionRef:
                group: traefik.io
                kind: Middleware
                name: cors-header
              type: ExtensionRef
          matches:
            - path:
                type: PathPrefix
                value: /keycloak
  9: |
    apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: cors-header
      namespace: platform-mesh-system
    spec:
      headers:
        accessControlAllowCredentials: true
        accessControlAllowHeaders:
          - '*'
        accessControlAllowMethods:
          - GET
          - OPTIONS
          - POST
        accessControlMaxAge: 100
        addVaryHeader: true
match snapshots w. kcp version:
  1: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: Gateway
    metadata:
      name: k8sapi-gateway
      namespace: platform-mesh-system
    spec:
      gatewayClassName: traefik
      listeners:
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: portal.localhost
          name: websecure
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: '*.portal.localhost'
          name: websecure-wildcard-portal-localhost
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: TLSRoute
            namespaces:
              from: All
          hostname: localhost
          name: https-passthrough
          port: 8443
          protocol: TLS
          tls:
            mode: Passthrough
  2: |
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: kcp-cluster-admin-client-cert
      namespace: platform-mesh-system
    spec:
      commonName: cluster-admin
      issuerRef:
        name: root-front-proxy-client-ca
      privateKey:
        algorithm: RSA
        size: 2048
      secretName: kcp-cluster-admin-client-cert
      subject:
        organizations:
          - system:kcp:admin
      usages:
        - client auth
  3: |
    apiVersion: druid.gardener.cloud/v1alpha1
    kind: Etcd
    metadata:
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      name: etcd-kcp
      namespace: platform-mesh-system
    spec:
      annotations:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      backup:
        compression:
          enabled: false
          policy: gzip
        deltaSnapshotMemoryLimit: 1Gi
        deltaSnapshotPeriod: 300s
        fullSnapshotSchedule: 0 */24 * * *
        garbageCollectionPeriod: 43200s
        garbageCollectionPolicy: Exponential
        leaderElection:
          etcdConnectionTimeout: 5s
          reelectionPeriod: 5s
        port: 8080
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 23m
            memory: 128Mi
      etcd:
        clientPort: 2379
        defragmentationSchedule: 0 */24 * * *
        metrics: basic
        quota: 8Gi
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 200Mi
        serverPort: 2380
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      replicas: 1
      sharedConfig:
        autoCompactionMode: periodic
        autoCompactionRetention: 30m
  4: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: FrontProxy
    metadata:
      name: frontproxy
      namespace: platform-mesh-system
    spec:
      additionalPathMappings:
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/contentconfigurations
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/marketplace
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      image:
        tag: v0.1.0
      replicas: 1
      rootShard:
        ref:
          name: root
      serviceTemplate:
        spec:
          ports:
            - appProtocol: https
              name: https
              port: 8443
              protocol: TCP
              targetPort: 6443
          type: ClusterIP
  5: |
    apiVersion: cert-manager.io/v1
    kind: Issuer
    metadata:
      name: selfsigned
      namespace: platform-mesh-system
    spec:
      selfSigned: {}
  6: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: RootShard
    metadata:
      name: root
      namespace: platform-mesh-system
    spec:
      authorization:
        webhook:
          configSecretName: kcp-webhook-secret
      cache:
        embedded:
          enabled: true
      certificates:
        issuerRef:
          group: cert-manager.io
          kind: Issuer
          name: selfsigned
      deploymentTemplate:
        spec:
          template:
            metadata:
              annotations:
                traffic.sidecar.istio.io/excludeOutboundPorts: "9443"
            spec: null
      etcd:
        endpoints:
          - http://etcd-kcp-client.platform-mesh-system.svc.cluster.local:2379
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      image:
        tag: v0.1.0
      proxy:
        image:
          tag: v0.1.0
      replicas: 1
  7: |
    apiVersion: gateway.networking.k8s.io/v1alpha2
    kind: TLSRoute
    metadata:
      name: kcp-front-proxy-tlsroute
    spec:
      hostnames:
        - localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: https-passthrough
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: frontproxy-front-proxy
              port: 6443
              weight: 1
          name: https-passthrough
  8: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: keycloak
    spec:
      hostnames:
        - portal.localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: keycloak
              namespace: platform-mesh-system
              port: 80
          filters:
            - extensionRef:
                group: traefik.io
                kind: Middleware
                name: cors-header
              type: ExtensionRef
          matches:
            - path:
                type: PathPrefix
                value: /keycloak
  9: |
    apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: cors-header
      namespace: platform-mesh-system
    spec:
      headers:
        accessControlAllowCredentials: true
        accessControlAllowHeaders:
          - '*'
        accessControlAllowMethods:
          - GET
          - OPTIONS
          - POST
        accessControlMaxAge: 100
        addVaryHeader: true
match snapshots with mailpit enabled:
  1: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: Gateway
    metadata:
      name: k8sapi-gateway
      namespace: platform-mesh-system
    spec:
      gatewayClassName: traefik
      listeners:
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: portal.localhost
          name: websecure
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: '*.portal.localhost'
          name: websecure-wildcard-portal-localhost
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: TLSRoute
            namespaces:
              from: All
          hostname: localhost
          name: https-passthrough
          port: 8443
          protocol: TLS
          tls:
            mode: Passthrough
  2: |
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: kcp-cluster-admin-client-cert
      namespace: platform-mesh-system
    spec:
      commonName: cluster-admin
      issuerRef:
        name: root-front-proxy-client-ca
      privateKey:
        algorithm: RSA
        size: 2048
      secretName: kcp-cluster-admin-client-cert
      subject:
        organizations:
          - system:kcp:admin
      usages:
        - client auth
  3: |
    apiVersion: druid.gardener.cloud/v1alpha1
    kind: Etcd
    metadata:
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      name: etcd-kcp
      namespace: platform-mesh-system
    spec:
      annotations:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      backup:
        compression:
          enabled: false
          policy: gzip
        deltaSnapshotMemoryLimit: 1Gi
        deltaSnapshotPeriod: 300s
        fullSnapshotSchedule: 0 */24 * * *
        garbageCollectionPeriod: 43200s
        garbageCollectionPolicy: Exponential
        leaderElection:
          etcdConnectionTimeout: 5s
          reelectionPeriod: 5s
        port: 8080
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 23m
            memory: 128Mi
      etcd:
        clientPort: 2379
        defragmentationSchedule: 0 */24 * * *
        metrics: basic
        quota: 8Gi
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 200Mi
        serverPort: 2380
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      replicas: 1
      sharedConfig:
        autoCompactionMode: periodic
        autoCompactionRetention: 30m
  4: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: FrontProxy
    metadata:
      name: frontproxy
      namespace: platform-mesh-system
    spec:
      additionalPathMappings:
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/contentconfigurations
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/marketplace
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
      rootShard:
        ref:
          name: root
      serviceTemplate:
        spec:
          ports:
            - appProtocol: https
              name: https
              port: 8443
              protocol: TCP
              targetPort: 6443
          type: ClusterIP
  5: |
    apiVersion: cert-manager.io/v1
    kind: Issuer
    metadata:
      name: selfsigned
      namespace: platform-mesh-system
    spec:
      selfSigned: {}
  6: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: RootShard
    metadata:
      name: root
      namespace: platform-mesh-system
    spec:
      authorization:
        webhook:
          configSecretName: kcp-webhook-secret
      cache:
        embedded:
          enabled: true
      certificates:
        issuerRef:
          group: cert-manager.io
          kind: Issuer
          name: selfsigned
      deploymentTemplate:
        spec:
          template:
            metadata:
              annotations:
                traffic.sidecar.istio.io/excludeOutboundPorts: "9443"
            spec: null
      etcd:
        endpoints:
          - http://etcd-kcp-client.platform-mesh-system.svc.cluster.local:2379
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
  7: |
    apiVersion: gateway.networking.k8s.io/v1alpha2
    kind: TLSRoute
    metadata:
      name: kcp-front-proxy-tlsroute
    spec:
      hostnames:
        - localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: https-passthrough
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: frontproxy-front-proxy
              port: 6443
              weight: 1
          name: https-passthrough
  8: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: keycloak
    spec:
      hostnames:
        - portal.localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: keycloak
              namespace: platform-mesh-system
              port: 80
          filters:
            - extensionRef:
                group: traefik.io
                kind: Middleware
                name: cors-header
              type: ExtensionRef
          matches:
            - path:
                type: PathPrefix
                value: /keycloak
  9: |
    apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: cors-header
      namespace: platform-mesh-system
    spec:
      headers:
        accessControlAllowCredentials: true
        accessControlAllowHeaders:
          - '*'
        accessControlAllowMethods:
          - GET
          - OPTIONS
          - POST
        accessControlMaxAge: 100
        addVaryHeader: true
