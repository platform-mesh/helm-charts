Gateway API enabled:
  1: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: Gateway
    metadata:
      name: k8sapi-gateway
      namespace: platform-mesh-system
    spec:
      gatewayClassName: traefik
      listeners:
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: portal.localhost
          name: websecure
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: '*.portal.localhost'
          name: websecure-wildcard-portal-localhost
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: TLSRoute
            namespaces:
              from: All
          hostname: localhost
          name: https-passthrough
          port: 8443
          protocol: TLS
          tls:
            mode: Passthrough
  2: |
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: kcp-cluster-admin-client-cert
      namespace: platform-mesh-system
    spec:
      commonName: cluster-admin
      issuerRef:
        name: root-front-proxy-client-ca
      privateKey:
        algorithm: RSA
        size: 2048
      secretName: kcp-cluster-admin-client-cert
      subject:
        organizations:
          - system:kcp:admin
      usages:
        - client auth
  3: |
    apiVersion: druid.gardener.cloud/v1alpha1
    kind: Etcd
    metadata:
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      name: etcd-kcp
      namespace: platform-mesh-system
    spec:
      annotations:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      backup:
        compression:
          enabled: false
          policy: gzip
        deltaSnapshotMemoryLimit: 1Gi
        deltaSnapshotPeriod: 300s
        fullSnapshotSchedule: 0 */24 * * *
        garbageCollectionPeriod: 43200s
        garbageCollectionPolicy: Exponential
        leaderElection:
          etcdConnectionTimeout: 5s
          reelectionPeriod: 5s
        port: 8080
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 23m
            memory: 128Mi
      etcd:
        clientPort: 2379
        defragmentationSchedule: 0 */24 * * *
        metrics: basic
        quota: 8Gi
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 200Mi
        serverPort: 2380
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      replicas: 1
      sharedConfig:
        autoCompactionMode: periodic
        autoCompactionRetention: 30m
  4: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: FrontProxy
    metadata:
      name: frontproxy
      namespace: platform-mesh-system
    spec:
      additionalPathMappings:
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/contentconfigurations
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/marketplace
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
      rootShard:
        ref:
          name: root
      serviceTemplate:
        spec:
          ports:
            - appProtocol: https
              name: https
              port: 8443
              protocol: TCP
              targetPort: 6443
          type: ClusterIP
  5: |
    apiVersion: cert-manager.io/v1
    kind: Issuer
    metadata:
      name: selfsigned
      namespace: platform-mesh-system
    spec:
      selfSigned: {}
  6: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: RootShard
    metadata:
      name: root
      namespace: platform-mesh-system
    spec:
      authorization:
        webhook:
          configSecretName: kcp-webhook-secret
      cache:
        embedded:
          enabled: true
      certificates:
        issuerRef:
          group: cert-manager.io
          kind: Issuer
          name: selfsigned
      deploymentTemplate:
        spec:
          template:
            metadata:
              annotations:
                traffic.sidecar.istio.io/excludeOutboundPorts: "9443"
            spec: null
      etcd:
        endpoints:
          - http://etcd-kcp-client.platform-mesh-system.svc.cluster.local:2379
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
  7: |
    apiVersion: gateway.networking.k8s.io/v1alpha2
    kind: TLSRoute
    metadata:
      name: kcp-front-proxy-tlsroute
    spec:
      hostnames:
        - localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: https-passthrough
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: frontproxy-front-proxy
              port: 6443
              weight: 1
          name: https-passthrough
  8: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: welcome
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: welcome
        enabled: true
        name: Welcome
        realmIdRef:
          name: welcome
        standardFlowEnabled: true
        validRedirectUris:
          - http://localhost:8000/callback*
          - http://localhost:4300/callback*
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: portal-client-secret-welcome
        namespace: platform-mesh-system
  9: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientDefaultScopes
    metadata:
      name: welcome-default-scopes
    spec:
      forProvider:
        clientIdRef:
          name: welcome
        defaultScopes:
          - profile
          - email
          - basic
          - acr
          - groups
          - trusted-platform-mesh-audiences
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  10: |
    apiVersion: defaults.keycloak.crossplane.io/v1alpha1
    kind: DefaultGroups
    metadata:
      name: default
    spec:
      forProvider:
        groupIdsRefs:
          - name: portal
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  11: |
    apiVersion: group.keycloak.crossplane.io/v1alpha1
    kind: Group
    metadata:
      name: portal
    spec:
      forProvider:
        name: portal
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  12: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientScope
    metadata:
      name: groups-client-scope
    spec:
      forProvider:
        description: When requested, this scope will map a user's group memberships to a claim
        includeInTokenScope: true
        name: groups
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  13: |
    apiVersion: openidgroup.keycloak.crossplane.io/v1alpha1
    kind: GroupMembershipProtocolMapper
    metadata:
      name: group-membership-mapper
    spec:
      forProvider:
        claimName: groups
        clientIdRef:
          name: groups-client-scope
        name: group-membership-mapper
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  14: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: iam
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: iam
        enabled: true
        name: iam
        realmId: master
        serviceAccountsEnabled: true
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: iam-client-secret
        namespace: platform-mesh-system
  15: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientServiceAccountRealmRole
    metadata:
      name: iam
    spec:
      forProvider:
        realmId: master
        role: admin
        serviceAccountUserClientIdRef:
          name: iam
      providerConfigRef:
        name: keycloak-provider-config
  16: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: security-operator
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: security-operator
        enabled: true
        name: security-operator
        realmId: master
        serviceAccountsEnabled: true
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: security-operator-client-secret
        namespace: platform-mesh-system
  17: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientServiceAccountRealmRole
    metadata:
      name: security-operator
    spec:
      forProvider:
        realmId: master
        role: admin
        serviceAccountUserClientIdRef:
          name: security-operator
      providerConfigRef:
        name: keycloak-provider-config
  18: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientScope
    metadata:
      name: trusted-platform-mesh-audiences
    spec:
      forProvider:
        includeInTokenScope: true
        name: trusted-platform-mesh-audiences
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  19: |
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
  20: |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    rules:
      - apiGroups:
          - ""
        resourceNames:
          - keycloak-admin
        resources:
          - secrets
        verbs:
          - get
      - apiGroups:
          - ""
        resourceNames:
          - keycloak-provider-config
        resources:
          - secrets
        verbs:
          - get
          - create
          - update
          - patch
          - delete
  21: |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: Role
      name: keycloak-provider-config-secret-creator
    subjects:
      - kind: ServiceAccount
        name: keycloak-provider-config-secret-creator
        namespace: platform-mesh-system
  22: |
    apiVersion: batch/v1
    kind: Job
    metadata:
      annotations:
        helm.sh/hook: post-install,post-upgrade
        helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
        helm.sh/hook-weight: "1"
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    spec:
      template:
        metadata:
          name: keycloak-provider-config-secret-creator
        spec:
          containers:
            - command:
                - /bin/sh
                - -c
                - |-
                  set -e

                  # Read the keycloak-admin secret
                  echo "Reading keycloak-admin secret..."
                  ADMIN_SECRET=$(kubectl get secret keycloak-admin -n platform-mesh-system -o jsonpath='{.data.secret}' 2>/dev/null || echo "")

                  if [ -z "$ADMIN_SECRET" ]; then
                    echo "Warning: keycloak-admin secret not found or secret key missing, using default password"
                    PASSWORD="aesaeXaefu0x"
                  else
                    # Decode base64 password
                    PASSWORD=$(echo "$ADMIN_SECRET" | base64 -d)
                  fi

                  # Escape password for JSON (escape backslashes, quotes, and newlines)
                  ESCAPED_PASSWORD=$(echo -n "$PASSWORD" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

                  # Create the provider config JSON using printf to avoid shell expansion issues
                  CONFIG_JSON=$(printf '{"client_id":"admin-cli","username":"keycloak-admin","password":"%s","url":"http://keycloak.platform-mesh-system.svc.cluster.local/keycloak","realm":"master"}' "$ESCAPED_PASSWORD")

                  # Check if secret already exists
                  if kubectl get secret keycloak-provider-config -n platform-mesh-system &>/dev/null; then
                    echo "Updating existing secret keycloak-provider-config..."
                    # Delete and recreate to ensure clean state
                    kubectl delete secret keycloak-provider-config -n platform-mesh-system --ignore-not-found=true
                  fi

                  echo "Creating secret keycloak-provider-config..."
                  kubectl create secret generic keycloak-provider-config \
                    --from-literal=config="$CONFIG_JSON" \
                    -n platform-mesh-system

                  echo "Secret keycloak-provider-config created/updated successfully"
              image: ghcr.io/platform-mesh/images/ocmbuilder:pr-4
              name: secret-creator
          restartPolicy: OnFailure
          serviceAccountName: keycloak-provider-config-secret-creator
  23: |
    apiVersion: keycloak.crossplane.io/v1beta1
    kind: ProviderConfig
    metadata:
      name: keycloak-provider-config
      namespace: platform-mesh-system
    spec:
      credentials:
        secretRef:
          key: config
          name: keycloak-provider-config
          namespace: platform-mesh-system
        source: Secret
  24: |
    apiVersion: realm.keycloak.crossplane.io/v1alpha1
    kind: Realm
    metadata:
      name: welcome
    spec:
      forProvider:
        accessTokenLifespan: 8h
        displayName: welcome
        displayNameHtml: <b>welcome</b>
        enabled: true
        loginWithEmailAllowed: true
        organizationsEnabled: true
        realm: welcome
        registrationAllowed: true
        registrationEmailAsUsername: true
        smtpServer:
          - from: noreply@portal.localhost
            host: mailpit.platform-mesh-system.svc.cluster.local
            port: "1025"
        ssoSessionIdleTimeout: 8h
        verifyEmail: true
      providerConfigRef:
        name: keycloak-provider-config
  25: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: keycloak
    spec:
      hostnames:
        - portal.localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: keycloak
              namespace: platform-mesh-system
              port: 80
          filters:
            - extensionRef:
                group: traefik.io
                kind: Middleware
                name: cors-header
              type: ExtensionRef
          matches:
            - path:
                type: PathPrefix
                value: /keycloak
  26: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: mailpit
    spec:
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: mailpit
              port: 8025
          filters:
            - extensionRef:
                group: traefik.io
                kind: Middleware
                name: cors-header
              type: ExtensionRef
          matches:
            - path:
                type: PathPrefix
                value: /mailpit
  27: |
    apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: cors-header
      namespace: platform-mesh-system
    spec:
      headers:
        accessControlAllowCredentials: true
        accessControlAllowHeaders:
          - '*'
        accessControlAllowMethods:
          - GET
          - OPTIONS
          - POST
        accessControlAllowOriginList:
          - http://localhost:4200
          - http://localhost:4300
          - http://*.localhost:4200
          - http://*.localhost:4300
          - https://portal.localhost:8443
          - https://*.portal.localhost:8443
        accessControlMaxAge: 100
        addVaryHeader: true
Istio disabled:
  1: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: Gateway
    metadata:
      name: k8sapi-gateway
      namespace: platform-mesh-system
    spec:
      gatewayClassName: traefik
      listeners:
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: portal.localhost
          name: websecure
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: '*.portal.localhost'
          name: websecure-wildcard-portal-localhost
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: TLSRoute
            namespaces:
              from: All
          hostname: localhost
          name: https-passthrough
          port: 8443
          protocol: TLS
          tls:
            mode: Passthrough
  2: |
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: kcp-cluster-admin-client-cert
      namespace: platform-mesh-system
    spec:
      commonName: cluster-admin
      issuerRef:
        name: root-front-proxy-client-ca
      privateKey:
        algorithm: RSA
        size: 2048
      secretName: kcp-cluster-admin-client-cert
      subject:
        organizations:
          - system:kcp:admin
      usages:
        - client auth
  3: |
    apiVersion: druid.gardener.cloud/v1alpha1
    kind: Etcd
    metadata:
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      name: etcd-kcp
      namespace: platform-mesh-system
    spec:
      annotations:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      backup:
        compression:
          enabled: false
          policy: gzip
        deltaSnapshotMemoryLimit: 1Gi
        deltaSnapshotPeriod: 300s
        fullSnapshotSchedule: 0 */24 * * *
        garbageCollectionPeriod: 43200s
        garbageCollectionPolicy: Exponential
        leaderElection:
          etcdConnectionTimeout: 5s
          reelectionPeriod: 5s
        port: 8080
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 23m
            memory: 128Mi
      etcd:
        clientPort: 2379
        defragmentationSchedule: 0 */24 * * *
        metrics: basic
        quota: 8Gi
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 200Mi
        serverPort: 2380
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      replicas: 1
      sharedConfig:
        autoCompactionMode: periodic
        autoCompactionRetention: 30m
  4: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: FrontProxy
    metadata:
      name: frontproxy
      namespace: platform-mesh-system
    spec:
      additionalPathMappings:
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/contentconfigurations
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/marketplace
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
      rootShard:
        ref:
          name: root
      serviceTemplate:
        spec:
          ports:
            - appProtocol: https
              name: https
              port: 8443
              protocol: TCP
              targetPort: 6443
          type: ClusterIP
  5: |
    apiVersion: cert-manager.io/v1
    kind: Issuer
    metadata:
      name: selfsigned
      namespace: platform-mesh-system
    spec:
      selfSigned: {}
  6: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: RootShard
    metadata:
      name: root
      namespace: platform-mesh-system
    spec:
      authorization:
        webhook:
          configSecretName: kcp-webhook-secret
      cache:
        embedded:
          enabled: true
      certificates:
        issuerRef:
          group: cert-manager.io
          kind: Issuer
          name: selfsigned
      deploymentTemplate:
        spec:
          template:
            metadata:
              annotations:
                traffic.sidecar.istio.io/excludeOutboundPorts: "9443"
            spec: null
      etcd:
        endpoints:
          - http://etcd-kcp-client.platform-mesh-system.svc.cluster.local:2379
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
  7: |
    apiVersion: gateway.networking.k8s.io/v1alpha2
    kind: TLSRoute
    metadata:
      name: kcp-front-proxy-tlsroute
    spec:
      hostnames:
        - localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: https-passthrough
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: frontproxy-front-proxy
              port: 6443
              weight: 1
          name: https-passthrough
  8: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: welcome
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: welcome
        enabled: true
        name: Welcome
        realmIdRef:
          name: welcome
        standardFlowEnabled: true
        validRedirectUris:
          - http://localhost:8000/callback*
          - http://localhost:4300/callback*
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: portal-client-secret-welcome
        namespace: platform-mesh-system
  9: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientDefaultScopes
    metadata:
      name: welcome-default-scopes
    spec:
      forProvider:
        clientIdRef:
          name: welcome
        defaultScopes:
          - profile
          - email
          - basic
          - acr
          - groups
          - trusted-platform-mesh-audiences
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  10: |
    apiVersion: defaults.keycloak.crossplane.io/v1alpha1
    kind: DefaultGroups
    metadata:
      name: default
    spec:
      forProvider:
        groupIdsRefs:
          - name: portal
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  11: |
    apiVersion: group.keycloak.crossplane.io/v1alpha1
    kind: Group
    metadata:
      name: portal
    spec:
      forProvider:
        name: portal
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  12: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientScope
    metadata:
      name: groups-client-scope
    spec:
      forProvider:
        description: When requested, this scope will map a user's group memberships to a claim
        includeInTokenScope: true
        name: groups
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  13: |
    apiVersion: openidgroup.keycloak.crossplane.io/v1alpha1
    kind: GroupMembershipProtocolMapper
    metadata:
      name: group-membership-mapper
    spec:
      forProvider:
        claimName: groups
        clientIdRef:
          name: groups-client-scope
        name: group-membership-mapper
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  14: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: iam
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: iam
        enabled: true
        name: iam
        realmId: master
        serviceAccountsEnabled: true
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: iam-client-secret
        namespace: platform-mesh-system
  15: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientServiceAccountRealmRole
    metadata:
      name: iam
    spec:
      forProvider:
        realmId: master
        role: admin
        serviceAccountUserClientIdRef:
          name: iam
      providerConfigRef:
        name: keycloak-provider-config
  16: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: security-operator
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: security-operator
        enabled: true
        name: security-operator
        realmId: master
        serviceAccountsEnabled: true
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: security-operator-client-secret
        namespace: platform-mesh-system
  17: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientServiceAccountRealmRole
    metadata:
      name: security-operator
    spec:
      forProvider:
        realmId: master
        role: admin
        serviceAccountUserClientIdRef:
          name: security-operator
      providerConfigRef:
        name: keycloak-provider-config
  18: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientScope
    metadata:
      name: trusted-platform-mesh-audiences
    spec:
      forProvider:
        includeInTokenScope: true
        name: trusted-platform-mesh-audiences
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  19: |
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
  20: |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    rules:
      - apiGroups:
          - ""
        resourceNames:
          - keycloak-admin
        resources:
          - secrets
        verbs:
          - get
      - apiGroups:
          - ""
        resourceNames:
          - keycloak-provider-config
        resources:
          - secrets
        verbs:
          - get
          - create
          - update
          - patch
          - delete
  21: |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: Role
      name: keycloak-provider-config-secret-creator
    subjects:
      - kind: ServiceAccount
        name: keycloak-provider-config-secret-creator
        namespace: platform-mesh-system
  22: |
    apiVersion: batch/v1
    kind: Job
    metadata:
      annotations:
        helm.sh/hook: post-install,post-upgrade
        helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
        helm.sh/hook-weight: "1"
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    spec:
      template:
        metadata:
          name: keycloak-provider-config-secret-creator
        spec:
          containers:
            - command:
                - /bin/sh
                - -c
                - |-
                  set -e

                  # Read the keycloak-admin secret
                  echo "Reading keycloak-admin secret..."
                  ADMIN_SECRET=$(kubectl get secret keycloak-admin -n platform-mesh-system -o jsonpath='{.data.secret}' 2>/dev/null || echo "")

                  if [ -z "$ADMIN_SECRET" ]; then
                    echo "Warning: keycloak-admin secret not found or secret key missing, using default password"
                    PASSWORD="aesaeXaefu0x"
                  else
                    # Decode base64 password
                    PASSWORD=$(echo "$ADMIN_SECRET" | base64 -d)
                  fi

                  # Escape password for JSON (escape backslashes, quotes, and newlines)
                  ESCAPED_PASSWORD=$(echo -n "$PASSWORD" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

                  # Create the provider config JSON using printf to avoid shell expansion issues
                  CONFIG_JSON=$(printf '{"client_id":"admin-cli","username":"keycloak-admin","password":"%s","url":"http://keycloak.platform-mesh-system.svc.cluster.local/keycloak","realm":"master"}' "$ESCAPED_PASSWORD")

                  # Check if secret already exists
                  if kubectl get secret keycloak-provider-config -n platform-mesh-system &>/dev/null; then
                    echo "Updating existing secret keycloak-provider-config..."
                    # Delete and recreate to ensure clean state
                    kubectl delete secret keycloak-provider-config -n platform-mesh-system --ignore-not-found=true
                  fi

                  echo "Creating secret keycloak-provider-config..."
                  kubectl create secret generic keycloak-provider-config \
                    --from-literal=config="$CONFIG_JSON" \
                    -n platform-mesh-system

                  echo "Secret keycloak-provider-config created/updated successfully"
              image: ghcr.io/platform-mesh/images/ocmbuilder:pr-4
              name: secret-creator
          restartPolicy: OnFailure
          serviceAccountName: keycloak-provider-config-secret-creator
  23: |
    apiVersion: keycloak.crossplane.io/v1beta1
    kind: ProviderConfig
    metadata:
      name: keycloak-provider-config
      namespace: platform-mesh-system
    spec:
      credentials:
        secretRef:
          key: config
          name: keycloak-provider-config
          namespace: platform-mesh-system
        source: Secret
  24: |
    apiVersion: realm.keycloak.crossplane.io/v1alpha1
    kind: Realm
    metadata:
      name: welcome
    spec:
      forProvider:
        accessTokenLifespan: 8h
        displayName: welcome
        displayNameHtml: <b>welcome</b>
        enabled: true
        loginWithEmailAllowed: true
        organizationsEnabled: true
        realm: welcome
        registrationAllowed: true
        registrationEmailAsUsername: true
        smtpServer:
          - from: noreply@portal.localhost
            host: mailpit.platform-mesh-system.svc.cluster.local
            port: "1025"
        ssoSessionIdleTimeout: 8h
        verifyEmail: true
      providerConfigRef:
        name: keycloak-provider-config
  25: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: keycloak
    spec:
      hostnames:
        - portal.localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: keycloak
              namespace: platform-mesh-system
              port: 80
          matches:
            - path:
                type: PathPrefix
                value: /keycloak
  26: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: mailpit
    spec:
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: mailpit
              port: 8025
          matches:
            - path:
                type: PathPrefix
                value: /mailpit
Istio enabled:
  1: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: Gateway
    metadata:
      name: k8sapi-gateway
      namespace: platform-mesh-system
    spec:
      gatewayClassName: traefik
      listeners:
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: portal.localhost
          name: websecure
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: '*.portal.localhost'
          name: websecure-wildcard-portal-localhost
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: TLSRoute
            namespaces:
              from: All
          hostname: localhost
          name: https-passthrough
          port: 8443
          protocol: TLS
          tls:
            mode: Passthrough
  2: |
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: kcp-cluster-admin-client-cert
      namespace: platform-mesh-system
    spec:
      commonName: cluster-admin
      issuerRef:
        name: root-front-proxy-client-ca
      privateKey:
        algorithm: RSA
        size: 2048
      secretName: kcp-cluster-admin-client-cert
      subject:
        organizations:
          - system:kcp:admin
      usages:
        - client auth
  3: |
    apiVersion: druid.gardener.cloud/v1alpha1
    kind: Etcd
    metadata:
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      name: etcd-kcp
      namespace: platform-mesh-system
    spec:
      annotations:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      backup:
        compression:
          enabled: false
          policy: gzip
        deltaSnapshotMemoryLimit: 1Gi
        deltaSnapshotPeriod: 300s
        fullSnapshotSchedule: 0 */24 * * *
        garbageCollectionPeriod: 43200s
        garbageCollectionPolicy: Exponential
        leaderElection:
          etcdConnectionTimeout: 5s
          reelectionPeriod: 5s
        port: 8080
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 23m
            memory: 128Mi
      etcd:
        clientPort: 2379
        defragmentationSchedule: 0 */24 * * *
        metrics: basic
        quota: 8Gi
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 200Mi
        serverPort: 2380
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      replicas: 1
      sharedConfig:
        autoCompactionMode: periodic
        autoCompactionRetention: 30m
  4: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: FrontProxy
    metadata:
      name: frontproxy
      namespace: platform-mesh-system
    spec:
      additionalPathMappings:
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/contentconfigurations
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/marketplace
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
      rootShard:
        ref:
          name: root
      serviceTemplate:
        spec:
          ports:
            - appProtocol: https
              name: https
              port: 8443
              protocol: TCP
              targetPort: 6443
          type: ClusterIP
  5: |
    apiVersion: cert-manager.io/v1
    kind: Issuer
    metadata:
      name: selfsigned
      namespace: platform-mesh-system
    spec:
      selfSigned: {}
  6: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: RootShard
    metadata:
      name: root
      namespace: platform-mesh-system
    spec:
      authorization:
        webhook:
          configSecretName: kcp-webhook-secret
      cache:
        embedded:
          enabled: true
      certificates:
        issuerRef:
          group: cert-manager.io
          kind: Issuer
          name: selfsigned
      deploymentTemplate:
        spec:
          template:
            metadata:
              annotations:
                traffic.sidecar.istio.io/excludeOutboundPorts: "9443"
            spec: null
      etcd:
        endpoints:
          - http://etcd-kcp-client.platform-mesh-system.svc.cluster.local:2379
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
  7: |
    apiVersion: gateway.networking.k8s.io/v1alpha2
    kind: TLSRoute
    metadata:
      name: kcp-front-proxy-tlsroute
    spec:
      hostnames:
        - localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: https-passthrough
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: frontproxy-front-proxy
              port: 6443
              weight: 1
          name: https-passthrough
  8: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: welcome
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: welcome
        enabled: true
        name: Welcome
        realmIdRef:
          name: welcome
        standardFlowEnabled: true
        validRedirectUris:
          - http://localhost:8000/callback*
          - http://localhost:4300/callback*
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: portal-client-secret-welcome
        namespace: platform-mesh-system
  9: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientDefaultScopes
    metadata:
      name: welcome-default-scopes
    spec:
      forProvider:
        clientIdRef:
          name: welcome
        defaultScopes:
          - profile
          - email
          - basic
          - acr
          - groups
          - trusted-platform-mesh-audiences
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  10: |
    apiVersion: defaults.keycloak.crossplane.io/v1alpha1
    kind: DefaultGroups
    metadata:
      name: default
    spec:
      forProvider:
        groupIdsRefs:
          - name: portal
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  11: |
    apiVersion: group.keycloak.crossplane.io/v1alpha1
    kind: Group
    metadata:
      name: portal
    spec:
      forProvider:
        name: portal
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  12: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientScope
    metadata:
      name: groups-client-scope
    spec:
      forProvider:
        description: When requested, this scope will map a user's group memberships to a claim
        includeInTokenScope: true
        name: groups
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  13: |
    apiVersion: openidgroup.keycloak.crossplane.io/v1alpha1
    kind: GroupMembershipProtocolMapper
    metadata:
      name: group-membership-mapper
    spec:
      forProvider:
        claimName: groups
        clientIdRef:
          name: groups-client-scope
        name: group-membership-mapper
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  14: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: iam
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: iam
        enabled: true
        name: iam
        realmId: master
        serviceAccountsEnabled: true
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: iam-client-secret
        namespace: platform-mesh-system
  15: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientServiceAccountRealmRole
    metadata:
      name: iam
    spec:
      forProvider:
        realmId: master
        role: admin
        serviceAccountUserClientIdRef:
          name: iam
      providerConfigRef:
        name: keycloak-provider-config
  16: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: security-operator
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: security-operator
        enabled: true
        name: security-operator
        realmId: master
        serviceAccountsEnabled: true
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: security-operator-client-secret
        namespace: platform-mesh-system
  17: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientServiceAccountRealmRole
    metadata:
      name: security-operator
    spec:
      forProvider:
        realmId: master
        role: admin
        serviceAccountUserClientIdRef:
          name: security-operator
      providerConfigRef:
        name: keycloak-provider-config
  18: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientScope
    metadata:
      name: trusted-platform-mesh-audiences
    spec:
      forProvider:
        includeInTokenScope: true
        name: trusted-platform-mesh-audiences
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  19: |
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
  20: |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    rules:
      - apiGroups:
          - ""
        resourceNames:
          - keycloak-admin
        resources:
          - secrets
        verbs:
          - get
      - apiGroups:
          - ""
        resourceNames:
          - keycloak-provider-config
        resources:
          - secrets
        verbs:
          - get
          - create
          - update
          - patch
          - delete
  21: |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: Role
      name: keycloak-provider-config-secret-creator
    subjects:
      - kind: ServiceAccount
        name: keycloak-provider-config-secret-creator
        namespace: platform-mesh-system
  22: |
    apiVersion: batch/v1
    kind: Job
    metadata:
      annotations:
        helm.sh/hook: post-install,post-upgrade
        helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
        helm.sh/hook-weight: "1"
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    spec:
      template:
        metadata:
          name: keycloak-provider-config-secret-creator
        spec:
          containers:
            - command:
                - /bin/sh
                - -c
                - |-
                  set -e

                  # Read the keycloak-admin secret
                  echo "Reading keycloak-admin secret..."
                  ADMIN_SECRET=$(kubectl get secret keycloak-admin -n platform-mesh-system -o jsonpath='{.data.secret}' 2>/dev/null || echo "")

                  if [ -z "$ADMIN_SECRET" ]; then
                    echo "Warning: keycloak-admin secret not found or secret key missing, using default password"
                    PASSWORD="aesaeXaefu0x"
                  else
                    # Decode base64 password
                    PASSWORD=$(echo "$ADMIN_SECRET" | base64 -d)
                  fi

                  # Escape password for JSON (escape backslashes, quotes, and newlines)
                  ESCAPED_PASSWORD=$(echo -n "$PASSWORD" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

                  # Create the provider config JSON using printf to avoid shell expansion issues
                  CONFIG_JSON=$(printf '{"client_id":"admin-cli","username":"keycloak-admin","password":"%s","url":"http://keycloak.platform-mesh-system.svc.cluster.local/keycloak","realm":"master"}' "$ESCAPED_PASSWORD")

                  # Check if secret already exists
                  if kubectl get secret keycloak-provider-config -n platform-mesh-system &>/dev/null; then
                    echo "Updating existing secret keycloak-provider-config..."
                    # Delete and recreate to ensure clean state
                    kubectl delete secret keycloak-provider-config -n platform-mesh-system --ignore-not-found=true
                  fi

                  echo "Creating secret keycloak-provider-config..."
                  kubectl create secret generic keycloak-provider-config \
                    --from-literal=config="$CONFIG_JSON" \
                    -n platform-mesh-system

                  echo "Secret keycloak-provider-config created/updated successfully"
              image: ghcr.io/platform-mesh/images/ocmbuilder:pr-4
              name: secret-creator
          restartPolicy: OnFailure
          serviceAccountName: keycloak-provider-config-secret-creator
  23: |
    apiVersion: keycloak.crossplane.io/v1beta1
    kind: ProviderConfig
    metadata:
      name: keycloak-provider-config
      namespace: platform-mesh-system
    spec:
      credentials:
        secretRef:
          key: config
          name: keycloak-provider-config
          namespace: platform-mesh-system
        source: Secret
  24: |
    apiVersion: realm.keycloak.crossplane.io/v1alpha1
    kind: Realm
    metadata:
      name: welcome
    spec:
      forProvider:
        accessTokenLifespan: 8h
        displayName: welcome
        displayNameHtml: <b>welcome</b>
        enabled: true
        loginWithEmailAllowed: true
        organizationsEnabled: true
        realm: welcome
        registrationAllowed: true
        registrationEmailAsUsername: true
        smtpServer:
          - from: noreply@portal.localhost
            host: mailpit.platform-mesh-system.svc.cluster.local
            port: "1025"
        ssoSessionIdleTimeout: 8h
        verifyEmail: true
      providerConfigRef:
        name: keycloak-provider-config
  25: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: keycloak
    spec:
      hostnames:
        - portal.localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: keycloak
              namespace: platform-mesh-system
              port: 80
          matches:
            - path:
                type: PathPrefix
                value: /keycloak
  26: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: mailpit
    spec:
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: mailpit
              port: 8025
          matches:
            - path:
                type: PathPrefix
                value: /mailpit
  27: |
    apiVersion: security.istio.io/v1beta1
    kind: AuthorizationPolicy
    metadata:
      name: openfga
      namespace: platform-mesh-system
    spec:
      action: ALLOW
      rules:
        - from:
            - source:
                principals:
                  - cluster.local/ns/platform-mesh-system/sa/iam-service
                  - cluster.local/ns/platform-mesh-system/sa/security-operator
                  - cluster.local/ns/platform-mesh-system/sa/account-operator
          to:
            - operation:
                methods:
                  - POST
                  - GET
                  - PUT
        - from:
            - source:
                principals:
                  - cluster.local/ns/platform-mesh-system/*
          to:
            - operation:
                methods:
                  - GET
                paths:
                  - /stores*
            - operation:
                methods:
                  - POST
                paths:
                  - /stores/{*}/read
                  - /stores/{*}/write
                  - /stores/{*}/check
                  - /stores/{*}/batch-check
                  - /stores/{*}/expand
                  - /stores/{*}/list-objects
                  - /stores/{*}/streamed-list-objects
                  - /openfga.v1.OpenFGAService/Read*
                  - /openfga.v1.OpenFGAService/Check*
                  - /openfga.v1.OpenFGAService/BatchCheck*
                  - /openfga.v1.OpenFGAService/Expand*
                  - /openfga.v1.OpenFGAService/List*
                  - /openfga.v1.OpenFGAService/StreamedList*
      selector:
        matchLabels:
          app.kubernetes.io/name: openfga
  28: |
    apiVersion: networking.istio.io/v1alpha3
    kind: DestinationRule
    metadata:
      name: openfga
      namespace: platform-mesh-system
    spec:
      host: openfga.platform-mesh-system.svc.cluster.local
      trafficPolicy:
        tls:
          mode: ISTIO_MUTUAL
match snapshots:
  1: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: Gateway
    metadata:
      name: k8sapi-gateway
      namespace: platform-mesh-system
    spec:
      gatewayClassName: traefik
      listeners:
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: portal.localhost
          name: websecure
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: '*.portal.localhost'
          name: websecure-wildcard-portal-localhost
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: TLSRoute
            namespaces:
              from: All
          hostname: localhost
          name: https-passthrough
          port: 8443
          protocol: TLS
          tls:
            mode: Passthrough
  2: |
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: kcp-cluster-admin-client-cert
      namespace: platform-mesh-system
    spec:
      commonName: cluster-admin
      issuerRef:
        name: root-front-proxy-client-ca
      privateKey:
        algorithm: RSA
        size: 2048
      secretName: kcp-cluster-admin-client-cert
      subject:
        organizations:
          - system:kcp:admin
      usages:
        - client auth
  3: |
    apiVersion: druid.gardener.cloud/v1alpha1
    kind: Etcd
    metadata:
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      name: etcd-kcp
      namespace: platform-mesh-system
    spec:
      annotations:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      backup:
        compression:
          enabled: false
          policy: gzip
        deltaSnapshotMemoryLimit: 1Gi
        deltaSnapshotPeriod: 300s
        fullSnapshotSchedule: 0 */24 * * *
        garbageCollectionPeriod: 43200s
        garbageCollectionPolicy: Exponential
        leaderElection:
          etcdConnectionTimeout: 5s
          reelectionPeriod: 5s
        port: 8080
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 23m
            memory: 128Mi
      etcd:
        clientPort: 2379
        defragmentationSchedule: 0 */24 * * *
        metrics: basic
        quota: 8Gi
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 200Mi
        serverPort: 2380
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      replicas: 1
      sharedConfig:
        autoCompactionMode: periodic
        autoCompactionRetention: 30m
  4: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: FrontProxy
    metadata:
      name: frontproxy
      namespace: platform-mesh-system
    spec:
      additionalPathMappings:
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/contentconfigurations
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/marketplace
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      image:
        tag: 0.0.0
      replicas: 1
      rootShard:
        ref:
          name: root
      serviceTemplate:
        spec:
          ports:
            - appProtocol: https
              name: https
              port: 8443
              protocol: TCP
              targetPort: 6443
          type: ClusterIP
  5: |
    apiVersion: cert-manager.io/v1
    kind: Issuer
    metadata:
      name: selfsigned
      namespace: platform-mesh-system
    spec:
      selfSigned: {}
  6: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: RootShard
    metadata:
      name: root
      namespace: platform-mesh-system
    spec:
      authorization:
        webhook:
          configSecretName: kcp-webhook-secret
      cache:
        embedded:
          enabled: true
      certificates:
        issuerRef:
          group: cert-manager.io
          kind: Issuer
          name: selfsigned
      deploymentTemplate:
        spec:
          template:
            metadata:
              annotations:
                traffic.sidecar.istio.io/excludeOutboundPorts: "9443"
            spec: null
      etcd:
        endpoints:
          - http://etcd-kcp-client.platform-mesh-system.svc.cluster.local:2379
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      image:
        tag: 0.0.0
      proxy:
        image:
          tag: 0.0.0
      replicas: 1
  7: |
    apiVersion: gateway.networking.k8s.io/v1alpha2
    kind: TLSRoute
    metadata:
      name: kcp-front-proxy-tlsroute
    spec:
      hostnames:
        - localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: https-passthrough
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: frontproxy-front-proxy
              port: 6443
              weight: 1
          name: https-passthrough
  8: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: welcome
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: welcome
        enabled: true
        name: Welcome
        realmIdRef:
          name: welcome
        standardFlowEnabled: true
        validRedirectUris:
          - http://localhost:8000/callback*
          - http://localhost:4300/callback*
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: portal-client-secret-welcome
        namespace: platform-mesh-system
  9: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientDefaultScopes
    metadata:
      name: welcome-default-scopes
    spec:
      forProvider:
        clientIdRef:
          name: welcome
        defaultScopes:
          - profile
          - email
          - basic
          - acr
          - groups
          - trusted-platform-mesh-audiences
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  10: |
    apiVersion: defaults.keycloak.crossplane.io/v1alpha1
    kind: DefaultGroups
    metadata:
      name: default
    spec:
      forProvider:
        groupIdsRefs:
          - name: portal
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  11: |
    apiVersion: group.keycloak.crossplane.io/v1alpha1
    kind: Group
    metadata:
      name: portal
    spec:
      forProvider:
        name: portal
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  12: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientScope
    metadata:
      name: groups-client-scope
    spec:
      forProvider:
        description: When requested, this scope will map a user's group memberships to a claim
        includeInTokenScope: true
        name: groups
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  13: |
    apiVersion: openidgroup.keycloak.crossplane.io/v1alpha1
    kind: GroupMembershipProtocolMapper
    metadata:
      name: group-membership-mapper
    spec:
      forProvider:
        claimName: groups
        clientIdRef:
          name: groups-client-scope
        name: group-membership-mapper
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  14: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: iam
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: iam
        enabled: true
        name: iam
        realmId: master
        serviceAccountsEnabled: true
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: iam-client-secret
        namespace: platform-mesh-system
  15: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientServiceAccountRealmRole
    metadata:
      name: iam
    spec:
      forProvider:
        realmId: master
        role: admin
        serviceAccountUserClientIdRef:
          name: iam
      providerConfigRef:
        name: keycloak-provider-config
  16: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: security-operator
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: security-operator
        enabled: true
        name: security-operator
        realmId: master
        serviceAccountsEnabled: true
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: security-operator-client-secret
        namespace: platform-mesh-system
  17: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientServiceAccountRealmRole
    metadata:
      name: security-operator
    spec:
      forProvider:
        realmId: master
        role: admin
        serviceAccountUserClientIdRef:
          name: security-operator
      providerConfigRef:
        name: keycloak-provider-config
  18: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientScope
    metadata:
      name: trusted-platform-mesh-audiences
    spec:
      forProvider:
        includeInTokenScope: true
        name: trusted-platform-mesh-audiences
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  19: |
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
  20: |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    rules:
      - apiGroups:
          - ""
        resourceNames:
          - keycloak-admin
        resources:
          - secrets
        verbs:
          - get
      - apiGroups:
          - ""
        resourceNames:
          - keycloak-provider-config
        resources:
          - secrets
        verbs:
          - get
          - create
          - update
          - patch
          - delete
  21: |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: Role
      name: keycloak-provider-config-secret-creator
    subjects:
      - kind: ServiceAccount
        name: keycloak-provider-config-secret-creator
        namespace: platform-mesh-system
  22: |
    apiVersion: batch/v1
    kind: Job
    metadata:
      annotations:
        helm.sh/hook: post-install,post-upgrade
        helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
        helm.sh/hook-weight: "1"
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    spec:
      template:
        metadata:
          name: keycloak-provider-config-secret-creator
        spec:
          containers:
            - command:
                - /bin/sh
                - -c
                - |-
                  set -e

                  # Read the keycloak-admin secret
                  echo "Reading keycloak-admin secret..."
                  ADMIN_SECRET=$(kubectl get secret keycloak-admin -n platform-mesh-system -o jsonpath='{.data.secret}' 2>/dev/null || echo "")

                  if [ -z "$ADMIN_SECRET" ]; then
                    echo "Warning: keycloak-admin secret not found or secret key missing, using default password"
                    PASSWORD="aesaeXaefu0x"
                  else
                    # Decode base64 password
                    PASSWORD=$(echo "$ADMIN_SECRET" | base64 -d)
                  fi

                  # Escape password for JSON (escape backslashes, quotes, and newlines)
                  ESCAPED_PASSWORD=$(echo -n "$PASSWORD" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

                  # Create the provider config JSON using printf to avoid shell expansion issues
                  CONFIG_JSON=$(printf '{"client_id":"admin-cli","username":"keycloak-admin","password":"%s","url":"http://keycloak.platform-mesh-system.svc.cluster.local/keycloak","realm":"master"}' "$ESCAPED_PASSWORD")

                  # Check if secret already exists
                  if kubectl get secret keycloak-provider-config -n platform-mesh-system &>/dev/null; then
                    echo "Updating existing secret keycloak-provider-config..."
                    # Delete and recreate to ensure clean state
                    kubectl delete secret keycloak-provider-config -n platform-mesh-system --ignore-not-found=true
                  fi

                  echo "Creating secret keycloak-provider-config..."
                  kubectl create secret generic keycloak-provider-config \
                    --from-literal=config="$CONFIG_JSON" \
                    -n platform-mesh-system

                  echo "Secret keycloak-provider-config created/updated successfully"
              image: ghcr.io/platform-mesh/images/ocmbuilder:pr-4
              name: secret-creator
          restartPolicy: OnFailure
          serviceAccountName: keycloak-provider-config-secret-creator
  23: |
    apiVersion: keycloak.crossplane.io/v1beta1
    kind: ProviderConfig
    metadata:
      name: keycloak-provider-config
      namespace: platform-mesh-system
    spec:
      credentials:
        secretRef:
          key: config
          name: keycloak-provider-config
          namespace: platform-mesh-system
        source: Secret
  24: |
    apiVersion: realm.keycloak.crossplane.io/v1alpha1
    kind: Realm
    metadata:
      name: welcome
    spec:
      forProvider:
        accessTokenLifespan: 8h
        displayName: welcome
        displayNameHtml: <b>welcome</b>
        enabled: true
        loginWithEmailAllowed: true
        organizationsEnabled: true
        realm: welcome
        registrationAllowed: true
        registrationEmailAsUsername: true
        smtpServer:
          - from: noreply@portal.localhost
            host: mailpit.platform-mesh-system.svc.cluster.local
            port: "1025"
        ssoSessionIdleTimeout: 8h
        verifyEmail: true
      providerConfigRef:
        name: keycloak-provider-config
  25: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: keycloak
    spec:
      hostnames:
        - portal.localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: keycloak
              namespace: platform-mesh-system
              port: 80
          matches:
            - path:
                type: PathPrefix
                value: /keycloak
  26: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: mailpit
    spec:
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: mailpit
              port: 8025
          matches:
            - path:
                type: PathPrefix
                value: /mailpit
match snapshots w. hostAliases enabled:
  1: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: Gateway
    metadata:
      name: k8sapi-gateway
      namespace: platform-mesh-system
    spec:
      gatewayClassName: traefik
      listeners:
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: portal.localhost
          name: websecure
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: '*.portal.localhost'
          name: websecure-wildcard-portal-localhost
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: TLSRoute
            namespaces:
              from: All
          hostname: localhost
          name: https-passthrough
          port: 8443
          protocol: TLS
          tls:
            mode: Passthrough
  2: |
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: kcp-cluster-admin-client-cert
      namespace: platform-mesh-system
    spec:
      commonName: cluster-admin
      issuerRef:
        name: root-front-proxy-client-ca
      privateKey:
        algorithm: RSA
        size: 2048
      secretName: kcp-cluster-admin-client-cert
      subject:
        organizations:
          - system:kcp:admin
      usages:
        - client auth
  3: |
    apiVersion: druid.gardener.cloud/v1alpha1
    kind: Etcd
    metadata:
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      name: etcd-kcp
      namespace: platform-mesh-system
    spec:
      annotations:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      backup:
        compression:
          enabled: false
          policy: gzip
        deltaSnapshotMemoryLimit: 1Gi
        deltaSnapshotPeriod: 300s
        fullSnapshotSchedule: 0 */24 * * *
        garbageCollectionPeriod: 43200s
        garbageCollectionPolicy: Exponential
        leaderElection:
          etcdConnectionTimeout: 5s
          reelectionPeriod: 5s
        port: 8080
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 23m
            memory: 128Mi
      etcd:
        clientPort: 2379
        defragmentationSchedule: 0 */24 * * *
        metrics: basic
        quota: 8Gi
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 200Mi
        serverPort: 2380
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      replicas: 1
      sharedConfig:
        autoCompactionMode: periodic
        autoCompactionRetention: 30m
  4: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: FrontProxy
    metadata:
      name: frontproxy
      namespace: platform-mesh-system
    spec:
      additionalPathMappings:
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/contentconfigurations
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/marketplace
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
      deploymentTemplate:
        spec:
          template:
            spec:
              hostAliases:
                - hostnames:
                    - localhost
                    - portal.localhost
                  ip: 10.96.188.4
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
      rootShard:
        ref:
          name: root
      serviceTemplate:
        spec:
          clusterIP: 10.0.0.1
          ports:
            - appProtocol: https
              name: https
              port: 8443
              protocol: TCP
              targetPort: 6443
          type: ClusterIP
  5: |
    apiVersion: cert-manager.io/v1
    kind: Issuer
    metadata:
      name: selfsigned
      namespace: platform-mesh-system
    spec:
      selfSigned: {}
  6: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: RootShard
    metadata:
      name: root
      namespace: platform-mesh-system
    spec:
      authorization:
        webhook:
          configSecretName: kcp-webhook-secret
      cache:
        embedded:
          enabled: true
      certificates:
        issuerRef:
          group: cert-manager.io
          kind: Issuer
          name: selfsigned
      deploymentTemplate:
        spec:
          template:
            metadata:
              annotations:
                traffic.sidecar.istio.io/excludeOutboundPorts: "9443"
            spec:
              hostAliases:
                - hostnames:
                    - localhost
                    - portal.localhost
                  ip: 10.96.188.4
      etcd:
        endpoints:
          - http://etcd-kcp-client.platform-mesh-system.svc.cluster.local:2379
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
  7: |
    apiVersion: gateway.networking.k8s.io/v1alpha2
    kind: TLSRoute
    metadata:
      name: kcp-front-proxy-tlsroute
    spec:
      hostnames:
        - localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: https-passthrough
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: frontproxy-front-proxy
              port: 6443
              weight: 1
          name: https-passthrough
  8: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: welcome
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: welcome
        enabled: true
        name: Welcome
        realmIdRef:
          name: welcome
        standardFlowEnabled: true
        validRedirectUris:
          - http://localhost:8000/callback*
          - http://localhost:4300/callback*
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: portal-client-secret-welcome
        namespace: platform-mesh-system
  9: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientDefaultScopes
    metadata:
      name: welcome-default-scopes
    spec:
      forProvider:
        clientIdRef:
          name: welcome
        defaultScopes:
          - profile
          - email
          - basic
          - acr
          - groups
          - trusted-platform-mesh-audiences
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  10: |
    apiVersion: defaults.keycloak.crossplane.io/v1alpha1
    kind: DefaultGroups
    metadata:
      name: default
    spec:
      forProvider:
        groupIdsRefs:
          - name: portal
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  11: |
    apiVersion: group.keycloak.crossplane.io/v1alpha1
    kind: Group
    metadata:
      name: portal
    spec:
      forProvider:
        name: portal
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  12: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientScope
    metadata:
      name: groups-client-scope
    spec:
      forProvider:
        description: When requested, this scope will map a user's group memberships to a claim
        includeInTokenScope: true
        name: groups
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  13: |
    apiVersion: openidgroup.keycloak.crossplane.io/v1alpha1
    kind: GroupMembershipProtocolMapper
    metadata:
      name: group-membership-mapper
    spec:
      forProvider:
        claimName: groups
        clientIdRef:
          name: groups-client-scope
        name: group-membership-mapper
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  14: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: iam
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: iam
        enabled: true
        name: iam
        realmId: master
        serviceAccountsEnabled: true
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: iam-client-secret
        namespace: platform-mesh-system
  15: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientServiceAccountRealmRole
    metadata:
      name: iam
    spec:
      forProvider:
        realmId: master
        role: admin
        serviceAccountUserClientIdRef:
          name: iam
      providerConfigRef:
        name: keycloak-provider-config
  16: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: security-operator
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: security-operator
        enabled: true
        name: security-operator
        realmId: master
        serviceAccountsEnabled: true
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: security-operator-client-secret
        namespace: platform-mesh-system
  17: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientServiceAccountRealmRole
    metadata:
      name: security-operator
    spec:
      forProvider:
        realmId: master
        role: admin
        serviceAccountUserClientIdRef:
          name: security-operator
      providerConfigRef:
        name: keycloak-provider-config
  18: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientScope
    metadata:
      name: trusted-platform-mesh-audiences
    spec:
      forProvider:
        includeInTokenScope: true
        name: trusted-platform-mesh-audiences
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  19: |
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
  20: |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    rules:
      - apiGroups:
          - ""
        resourceNames:
          - keycloak-admin
        resources:
          - secrets
        verbs:
          - get
      - apiGroups:
          - ""
        resourceNames:
          - keycloak-provider-config
        resources:
          - secrets
        verbs:
          - get
          - create
          - update
          - patch
          - delete
  21: |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: Role
      name: keycloak-provider-config-secret-creator
    subjects:
      - kind: ServiceAccount
        name: keycloak-provider-config-secret-creator
        namespace: platform-mesh-system
  22: |
    apiVersion: batch/v1
    kind: Job
    metadata:
      annotations:
        helm.sh/hook: post-install,post-upgrade
        helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
        helm.sh/hook-weight: "1"
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    spec:
      template:
        metadata:
          name: keycloak-provider-config-secret-creator
        spec:
          containers:
            - command:
                - /bin/sh
                - -c
                - |-
                  set -e

                  # Read the keycloak-admin secret
                  echo "Reading keycloak-admin secret..."
                  ADMIN_SECRET=$(kubectl get secret keycloak-admin -n platform-mesh-system -o jsonpath='{.data.secret}' 2>/dev/null || echo "")

                  if [ -z "$ADMIN_SECRET" ]; then
                    echo "Warning: keycloak-admin secret not found or secret key missing, using default password"
                    PASSWORD="aesaeXaefu0x"
                  else
                    # Decode base64 password
                    PASSWORD=$(echo "$ADMIN_SECRET" | base64 -d)
                  fi

                  # Escape password for JSON (escape backslashes, quotes, and newlines)
                  ESCAPED_PASSWORD=$(echo -n "$PASSWORD" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

                  # Create the provider config JSON using printf to avoid shell expansion issues
                  CONFIG_JSON=$(printf '{"client_id":"admin-cli","username":"keycloak-admin","password":"%s","url":"http://keycloak.platform-mesh-system.svc.cluster.local/keycloak","realm":"master"}' "$ESCAPED_PASSWORD")

                  # Check if secret already exists
                  if kubectl get secret keycloak-provider-config -n platform-mesh-system &>/dev/null; then
                    echo "Updating existing secret keycloak-provider-config..."
                    # Delete and recreate to ensure clean state
                    kubectl delete secret keycloak-provider-config -n platform-mesh-system --ignore-not-found=true
                  fi

                  echo "Creating secret keycloak-provider-config..."
                  kubectl create secret generic keycloak-provider-config \
                    --from-literal=config="$CONFIG_JSON" \
                    -n platform-mesh-system

                  echo "Secret keycloak-provider-config created/updated successfully"
              image: ghcr.io/platform-mesh/images/ocmbuilder:pr-4
              name: secret-creator
          restartPolicy: OnFailure
          serviceAccountName: keycloak-provider-config-secret-creator
  23: |
    apiVersion: keycloak.crossplane.io/v1beta1
    kind: ProviderConfig
    metadata:
      name: keycloak-provider-config
      namespace: platform-mesh-system
    spec:
      credentials:
        secretRef:
          key: config
          name: keycloak-provider-config
          namespace: platform-mesh-system
        source: Secret
  24: |
    apiVersion: realm.keycloak.crossplane.io/v1alpha1
    kind: Realm
    metadata:
      name: welcome
    spec:
      forProvider:
        accessTokenLifespan: 8h
        displayName: welcome
        displayNameHtml: <b>welcome</b>
        enabled: true
        loginWithEmailAllowed: true
        organizationsEnabled: true
        realm: welcome
        registrationAllowed: true
        registrationEmailAsUsername: true
        smtpServer:
          - from: noreply@portal.localhost
            host: mailpit.platform-mesh-system.svc.cluster.local
            port: "1025"
        ssoSessionIdleTimeout: 8h
        verifyEmail: true
      providerConfigRef:
        name: keycloak-provider-config
  25: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: keycloak
    spec:
      hostnames:
        - portal.localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: keycloak
              namespace: platform-mesh-system
              port: 80
          matches:
            - path:
                type: PathPrefix
                value: /keycloak
  26: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: mailpit
    spec:
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: mailpit
              port: 8025
          matches:
            - path:
                type: PathPrefix
                value: /mailpit
match snapshots w. kcp version:
  1: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: Gateway
    metadata:
      name: k8sapi-gateway
      namespace: platform-mesh-system
    spec:
      gatewayClassName: traefik
      listeners:
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: portal.localhost
          name: websecure
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: '*.portal.localhost'
          name: websecure-wildcard-portal-localhost
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: TLSRoute
            namespaces:
              from: All
          hostname: localhost
          name: https-passthrough
          port: 8443
          protocol: TLS
          tls:
            mode: Passthrough
  2: |
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: kcp-cluster-admin-client-cert
      namespace: platform-mesh-system
    spec:
      commonName: cluster-admin
      issuerRef:
        name: root-front-proxy-client-ca
      privateKey:
        algorithm: RSA
        size: 2048
      secretName: kcp-cluster-admin-client-cert
      subject:
        organizations:
          - system:kcp:admin
      usages:
        - client auth
  3: |
    apiVersion: druid.gardener.cloud/v1alpha1
    kind: Etcd
    metadata:
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      name: etcd-kcp
      namespace: platform-mesh-system
    spec:
      annotations:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      backup:
        compression:
          enabled: false
          policy: gzip
        deltaSnapshotMemoryLimit: 1Gi
        deltaSnapshotPeriod: 300s
        fullSnapshotSchedule: 0 */24 * * *
        garbageCollectionPeriod: 43200s
        garbageCollectionPolicy: Exponential
        leaderElection:
          etcdConnectionTimeout: 5s
          reelectionPeriod: 5s
        port: 8080
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 23m
            memory: 128Mi
      etcd:
        clientPort: 2379
        defragmentationSchedule: 0 */24 * * *
        metrics: basic
        quota: 8Gi
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 200Mi
        serverPort: 2380
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      replicas: 1
      sharedConfig:
        autoCompactionMode: periodic
        autoCompactionRetention: 30m
  4: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: FrontProxy
    metadata:
      name: frontproxy
      namespace: platform-mesh-system
    spec:
      additionalPathMappings:
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/contentconfigurations
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/marketplace
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      image:
        tag: v0.1.0
      replicas: 1
      rootShard:
        ref:
          name: root
      serviceTemplate:
        spec:
          ports:
            - appProtocol: https
              name: https
              port: 8443
              protocol: TCP
              targetPort: 6443
          type: ClusterIP
  5: |
    apiVersion: cert-manager.io/v1
    kind: Issuer
    metadata:
      name: selfsigned
      namespace: platform-mesh-system
    spec:
      selfSigned: {}
  6: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: RootShard
    metadata:
      name: root
      namespace: platform-mesh-system
    spec:
      authorization:
        webhook:
          configSecretName: kcp-webhook-secret
      cache:
        embedded:
          enabled: true
      certificates:
        issuerRef:
          group: cert-manager.io
          kind: Issuer
          name: selfsigned
      deploymentTemplate:
        spec:
          template:
            metadata:
              annotations:
                traffic.sidecar.istio.io/excludeOutboundPorts: "9443"
            spec: null
      etcd:
        endpoints:
          - http://etcd-kcp-client.platform-mesh-system.svc.cluster.local:2379
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      image:
        tag: v0.1.0
      proxy:
        image:
          tag: v0.1.0
      replicas: 1
  7: |
    apiVersion: gateway.networking.k8s.io/v1alpha2
    kind: TLSRoute
    metadata:
      name: kcp-front-proxy-tlsroute
    spec:
      hostnames:
        - localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: https-passthrough
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: frontproxy-front-proxy
              port: 6443
              weight: 1
          name: https-passthrough
  8: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: welcome
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: welcome
        enabled: true
        name: Welcome
        realmIdRef:
          name: welcome
        standardFlowEnabled: true
        validRedirectUris:
          - http://localhost:8000/callback*
          - http://localhost:4300/callback*
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: portal-client-secret-welcome
        namespace: platform-mesh-system
  9: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientDefaultScopes
    metadata:
      name: welcome-default-scopes
    spec:
      forProvider:
        clientIdRef:
          name: welcome
        defaultScopes:
          - profile
          - email
          - basic
          - acr
          - groups
          - trusted-platform-mesh-audiences
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  10: |
    apiVersion: defaults.keycloak.crossplane.io/v1alpha1
    kind: DefaultGroups
    metadata:
      name: default
    spec:
      forProvider:
        groupIdsRefs:
          - name: portal
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  11: |
    apiVersion: group.keycloak.crossplane.io/v1alpha1
    kind: Group
    metadata:
      name: portal
    spec:
      forProvider:
        name: portal
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  12: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientScope
    metadata:
      name: groups-client-scope
    spec:
      forProvider:
        description: When requested, this scope will map a user's group memberships to a claim
        includeInTokenScope: true
        name: groups
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  13: |
    apiVersion: openidgroup.keycloak.crossplane.io/v1alpha1
    kind: GroupMembershipProtocolMapper
    metadata:
      name: group-membership-mapper
    spec:
      forProvider:
        claimName: groups
        clientIdRef:
          name: groups-client-scope
        name: group-membership-mapper
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  14: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: iam
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: iam
        enabled: true
        name: iam
        realmId: master
        serviceAccountsEnabled: true
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: iam-client-secret
        namespace: platform-mesh-system
  15: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientServiceAccountRealmRole
    metadata:
      name: iam
    spec:
      forProvider:
        realmId: master
        role: admin
        serviceAccountUserClientIdRef:
          name: iam
      providerConfigRef:
        name: keycloak-provider-config
  16: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: security-operator
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: security-operator
        enabled: true
        name: security-operator
        realmId: master
        serviceAccountsEnabled: true
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: security-operator-client-secret
        namespace: platform-mesh-system
  17: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientServiceAccountRealmRole
    metadata:
      name: security-operator
    spec:
      forProvider:
        realmId: master
        role: admin
        serviceAccountUserClientIdRef:
          name: security-operator
      providerConfigRef:
        name: keycloak-provider-config
  18: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientScope
    metadata:
      name: trusted-platform-mesh-audiences
    spec:
      forProvider:
        includeInTokenScope: true
        name: trusted-platform-mesh-audiences
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  19: |
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
  20: |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    rules:
      - apiGroups:
          - ""
        resourceNames:
          - keycloak-admin
        resources:
          - secrets
        verbs:
          - get
      - apiGroups:
          - ""
        resourceNames:
          - keycloak-provider-config
        resources:
          - secrets
        verbs:
          - get
          - create
          - update
          - patch
          - delete
  21: |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: Role
      name: keycloak-provider-config-secret-creator
    subjects:
      - kind: ServiceAccount
        name: keycloak-provider-config-secret-creator
        namespace: platform-mesh-system
  22: |
    apiVersion: batch/v1
    kind: Job
    metadata:
      annotations:
        helm.sh/hook: post-install,post-upgrade
        helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
        helm.sh/hook-weight: "1"
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    spec:
      template:
        metadata:
          name: keycloak-provider-config-secret-creator
        spec:
          containers:
            - command:
                - /bin/sh
                - -c
                - |-
                  set -e

                  # Read the keycloak-admin secret
                  echo "Reading keycloak-admin secret..."
                  ADMIN_SECRET=$(kubectl get secret keycloak-admin -n platform-mesh-system -o jsonpath='{.data.secret}' 2>/dev/null || echo "")

                  if [ -z "$ADMIN_SECRET" ]; then
                    echo "Warning: keycloak-admin secret not found or secret key missing, using default password"
                    PASSWORD="aesaeXaefu0x"
                  else
                    # Decode base64 password
                    PASSWORD=$(echo "$ADMIN_SECRET" | base64 -d)
                  fi

                  # Escape password for JSON (escape backslashes, quotes, and newlines)
                  ESCAPED_PASSWORD=$(echo -n "$PASSWORD" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

                  # Create the provider config JSON using printf to avoid shell expansion issues
                  CONFIG_JSON=$(printf '{"client_id":"admin-cli","username":"keycloak-admin","password":"%s","url":"http://keycloak.platform-mesh-system.svc.cluster.local/keycloak","realm":"master"}' "$ESCAPED_PASSWORD")

                  # Check if secret already exists
                  if kubectl get secret keycloak-provider-config -n platform-mesh-system &>/dev/null; then
                    echo "Updating existing secret keycloak-provider-config..."
                    # Delete and recreate to ensure clean state
                    kubectl delete secret keycloak-provider-config -n platform-mesh-system --ignore-not-found=true
                  fi

                  echo "Creating secret keycloak-provider-config..."
                  kubectl create secret generic keycloak-provider-config \
                    --from-literal=config="$CONFIG_JSON" \
                    -n platform-mesh-system

                  echo "Secret keycloak-provider-config created/updated successfully"
              image: ghcr.io/platform-mesh/images/ocmbuilder:pr-4
              name: secret-creator
          restartPolicy: OnFailure
          serviceAccountName: keycloak-provider-config-secret-creator
  23: |
    apiVersion: keycloak.crossplane.io/v1beta1
    kind: ProviderConfig
    metadata:
      name: keycloak-provider-config
      namespace: platform-mesh-system
    spec:
      credentials:
        secretRef:
          key: config
          name: keycloak-provider-config
          namespace: platform-mesh-system
        source: Secret
  24: |
    apiVersion: realm.keycloak.crossplane.io/v1alpha1
    kind: Realm
    metadata:
      name: welcome
    spec:
      forProvider:
        accessTokenLifespan: 8h
        displayName: welcome
        displayNameHtml: <b>welcome</b>
        enabled: true
        loginWithEmailAllowed: true
        organizationsEnabled: true
        realm: welcome
        registrationAllowed: true
        registrationEmailAsUsername: true
        smtpServer:
          - from: noreply@portal.localhost
            host: mailpit.platform-mesh-system.svc.cluster.local
            port: "1025"
        ssoSessionIdleTimeout: 8h
        verifyEmail: true
      providerConfigRef:
        name: keycloak-provider-config
  25: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: keycloak
    spec:
      hostnames:
        - portal.localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: keycloak
              namespace: platform-mesh-system
              port: 80
          matches:
            - path:
                type: PathPrefix
                value: /keycloak
  26: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: mailpit
    spec:
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: mailpit
              port: 8025
          matches:
            - path:
                type: PathPrefix
                value: /mailpit
match snapshots with mailpit enabled:
  1: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: Gateway
    metadata:
      name: k8sapi-gateway
      namespace: platform-mesh-system
    spec:
      gatewayClassName: traefik
      listeners:
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: portal.localhost
          name: websecure
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
            namespaces:
              from: All
          hostname: '*.portal.localhost'
          name: websecure-wildcard-portal-localhost
          port: 8443
          protocol: HTTPS
          tls:
            certificateRefs:
              - group: ""
                kind: Secret
                name: domain-certificate
                namespace: platform-mesh-system
            mode: Terminate
        - allowedRoutes:
            kinds:
              - group: gateway.networking.k8s.io
                kind: TLSRoute
            namespaces:
              from: All
          hostname: localhost
          name: https-passthrough
          port: 8443
          protocol: TLS
          tls:
            mode: Passthrough
  2: |
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: kcp-cluster-admin-client-cert
      namespace: platform-mesh-system
    spec:
      commonName: cluster-admin
      issuerRef:
        name: root-front-proxy-client-ca
      privateKey:
        algorithm: RSA
        size: 2048
      secretName: kcp-cluster-admin-client-cert
      subject:
        organizations:
          - system:kcp:admin
      usages:
        - client auth
  3: |
    apiVersion: druid.gardener.cloud/v1alpha1
    kind: Etcd
    metadata:
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      name: etcd-kcp
      namespace: platform-mesh-system
    spec:
      annotations:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      backup:
        compression:
          enabled: false
          policy: gzip
        deltaSnapshotMemoryLimit: 1Gi
        deltaSnapshotPeriod: 300s
        fullSnapshotSchedule: 0 */24 * * *
        garbageCollectionPeriod: 43200s
        garbageCollectionPolicy: Exponential
        leaderElection:
          etcdConnectionTimeout: 5s
          reelectionPeriod: 5s
        port: 8080
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 23m
            memory: 128Mi
      etcd:
        clientPort: 2379
        defragmentationSchedule: 0 */24 * * *
        metrics: basic
        quota: 8Gi
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 200Mi
        serverPort: 2380
      labels:
        app: etcd-statefulset
        gardener.cloud/role: controlplane
        role: kcp
      replicas: 1
      sharedConfig:
        autoCompactionMode: periodic
        autoCompactionRetention: 30m
  4: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: FrontProxy
    metadata:
      name: frontproxy
      namespace: platform-mesh-system
    spec:
      additionalPathMappings:
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/contentconfigurations
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
        - backend: https://virtual-workspaces.platform-mesh-system:8443
          backend_server_ca: /etc/kcp/tls/ca/tls.crt
          path: /services/marketplace
          proxy_client_cert: /etc/kcp-front-proxy/requestheader-client/tls.crt
          proxy_client_key: /etc/kcp-front-proxy/requestheader-client/tls.key
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
      rootShard:
        ref:
          name: root
      serviceTemplate:
        spec:
          ports:
            - appProtocol: https
              name: https
              port: 8443
              protocol: TCP
              targetPort: 6443
          type: ClusterIP
  5: |
    apiVersion: cert-manager.io/v1
    kind: Issuer
    metadata:
      name: selfsigned
      namespace: platform-mesh-system
    spec:
      selfSigned: {}
  6: |
    apiVersion: operator.kcp.io/v1alpha1
    kind: RootShard
    metadata:
      name: root
      namespace: platform-mesh-system
    spec:
      authorization:
        webhook:
          configSecretName: kcp-webhook-secret
      cache:
        embedded:
          enabled: true
      certificates:
        issuerRef:
          group: cert-manager.io
          kind: Issuer
          name: selfsigned
      deploymentTemplate:
        spec:
          template:
            metadata:
              annotations:
                traffic.sidecar.istio.io/excludeOutboundPorts: "9443"
            spec: null
      etcd:
        endpoints:
          - http://etcd-kcp-client.platform-mesh-system.svc.cluster.local:2379
      external:
        hostname: localhost
        port: 8443
      extraArgs:
        - --feature-gates=WorkspaceAuthentication=true
      replicas: 1
  7: |
    apiVersion: gateway.networking.k8s.io/v1alpha2
    kind: TLSRoute
    metadata:
      name: kcp-front-proxy-tlsroute
    spec:
      hostnames:
        - localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: https-passthrough
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: frontproxy-front-proxy
              port: 6443
              weight: 1
          name: https-passthrough
  8: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: welcome
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: welcome
        enabled: true
        name: Welcome
        realmIdRef:
          name: welcome
        standardFlowEnabled: true
        validRedirectUris:
          - http://localhost:8000/callback*
          - http://localhost:4300/callback*
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: portal-client-secret-welcome
        namespace: platform-mesh-system
  9: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientDefaultScopes
    metadata:
      name: welcome-default-scopes
    spec:
      forProvider:
        clientIdRef:
          name: welcome
        defaultScopes:
          - profile
          - email
          - basic
          - acr
          - groups
          - trusted-platform-mesh-audiences
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  10: |
    apiVersion: defaults.keycloak.crossplane.io/v1alpha1
    kind: DefaultGroups
    metadata:
      name: default
    spec:
      forProvider:
        groupIdsRefs:
          - name: portal
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  11: |
    apiVersion: group.keycloak.crossplane.io/v1alpha1
    kind: Group
    metadata:
      name: portal
    spec:
      forProvider:
        name: portal
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  12: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientScope
    metadata:
      name: groups-client-scope
    spec:
      forProvider:
        description: When requested, this scope will map a user's group memberships to a claim
        includeInTokenScope: true
        name: groups
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  13: |
    apiVersion: openidgroup.keycloak.crossplane.io/v1alpha1
    kind: GroupMembershipProtocolMapper
    metadata:
      name: group-membership-mapper
    spec:
      forProvider:
        claimName: groups
        clientIdRef:
          name: groups-client-scope
        name: group-membership-mapper
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  14: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: iam
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: iam
        enabled: true
        name: iam
        realmId: master
        serviceAccountsEnabled: true
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: iam-client-secret
        namespace: platform-mesh-system
  15: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientServiceAccountRealmRole
    metadata:
      name: iam
    spec:
      forProvider:
        realmId: master
        role: admin
        serviceAccountUserClientIdRef:
          name: iam
      providerConfigRef:
        name: keycloak-provider-config
  16: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: Client
    metadata:
      name: security-operator
    spec:
      forProvider:
        accessType: CONFIDENTIAL
        clientId: security-operator
        enabled: true
        name: security-operator
        realmId: master
        serviceAccountsEnabled: true
      providerConfigRef:
        name: keycloak-provider-config
      writeConnectionSecretToRef:
        name: security-operator-client-secret
        namespace: platform-mesh-system
  17: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientServiceAccountRealmRole
    metadata:
      name: security-operator
    spec:
      forProvider:
        realmId: master
        role: admin
        serviceAccountUserClientIdRef:
          name: security-operator
      providerConfigRef:
        name: keycloak-provider-config
  18: |
    apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
    kind: ClientScope
    metadata:
      name: trusted-platform-mesh-audiences
    spec:
      forProvider:
        includeInTokenScope: true
        name: trusted-platform-mesh-audiences
        realmIdRef:
          name: welcome
      providerConfigRef:
        name: keycloak-provider-config
  19: |
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
  20: |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    rules:
      - apiGroups:
          - ""
        resourceNames:
          - keycloak-admin
        resources:
          - secrets
        verbs:
          - get
      - apiGroups:
          - ""
        resourceNames:
          - keycloak-provider-config
        resources:
          - secrets
        verbs:
          - get
          - create
          - update
          - patch
          - delete
  21: |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: Role
      name: keycloak-provider-config-secret-creator
    subjects:
      - kind: ServiceAccount
        name: keycloak-provider-config-secret-creator
        namespace: platform-mesh-system
  22: |
    apiVersion: batch/v1
    kind: Job
    metadata:
      annotations:
        helm.sh/hook: post-install,post-upgrade
        helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
        helm.sh/hook-weight: "1"
      name: keycloak-provider-config-secret-creator
      namespace: platform-mesh-system
    spec:
      template:
        metadata:
          name: keycloak-provider-config-secret-creator
        spec:
          containers:
            - command:
                - /bin/sh
                - -c
                - |-
                  set -e

                  # Read the keycloak-admin secret
                  echo "Reading keycloak-admin secret..."
                  ADMIN_SECRET=$(kubectl get secret keycloak-admin -n platform-mesh-system -o jsonpath='{.data.secret}' 2>/dev/null || echo "")

                  if [ -z "$ADMIN_SECRET" ]; then
                    echo "Warning: keycloak-admin secret not found or secret key missing, using default password"
                    PASSWORD="aesaeXaefu0x"
                  else
                    # Decode base64 password
                    PASSWORD=$(echo "$ADMIN_SECRET" | base64 -d)
                  fi

                  # Escape password for JSON (escape backslashes, quotes, and newlines)
                  ESCAPED_PASSWORD=$(echo -n "$PASSWORD" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

                  # Create the provider config JSON using printf to avoid shell expansion issues
                  CONFIG_JSON=$(printf '{"client_id":"admin-cli","username":"keycloak-admin","password":"%s","url":"http://keycloak.platform-mesh-system.svc.cluster.local/keycloak","realm":"master"}' "$ESCAPED_PASSWORD")

                  # Check if secret already exists
                  if kubectl get secret keycloak-provider-config -n platform-mesh-system &>/dev/null; then
                    echo "Updating existing secret keycloak-provider-config..."
                    # Delete and recreate to ensure clean state
                    kubectl delete secret keycloak-provider-config -n platform-mesh-system --ignore-not-found=true
                  fi

                  echo "Creating secret keycloak-provider-config..."
                  kubectl create secret generic keycloak-provider-config \
                    --from-literal=config="$CONFIG_JSON" \
                    -n platform-mesh-system

                  echo "Secret keycloak-provider-config created/updated successfully"
              image: ghcr.io/platform-mesh/images/ocmbuilder:pr-4
              name: secret-creator
          restartPolicy: OnFailure
          serviceAccountName: keycloak-provider-config-secret-creator
  23: |
    apiVersion: keycloak.crossplane.io/v1beta1
    kind: ProviderConfig
    metadata:
      name: keycloak-provider-config
      namespace: platform-mesh-system
    spec:
      credentials:
        secretRef:
          key: config
          name: keycloak-provider-config
          namespace: platform-mesh-system
        source: Secret
  24: |
    apiVersion: realm.keycloak.crossplane.io/v1alpha1
    kind: Realm
    metadata:
      name: welcome
    spec:
      forProvider:
        accessTokenLifespan: 8h
        displayName: welcome
        displayNameHtml: <b>welcome</b>
        enabled: true
        loginWithEmailAllowed: true
        organizationsEnabled: true
        realm: welcome
        registrationAllowed: true
        registrationEmailAsUsername: true
        smtpServer:
          - from: noreply@portal.localhost
            host: mailpit.platform-mesh-system.svc.cluster.local
            port: "1025"
        ssoSessionIdleTimeout: 8h
        verifyEmail: true
      providerConfigRef:
        name: keycloak-provider-config
  25: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: keycloak
    spec:
      hostnames:
        - portal.localhost
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: keycloak
              namespace: platform-mesh-system
              port: 80
          matches:
            - path:
                type: PathPrefix
                value: /keycloak
  26: |
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: mailpit
    spec:
      selector:
        matchLabels:
          app: mailpit
      template:
        metadata:
          labels:
            app: mailpit
        spec:
          containers:
            - args:
                - --webroot=/mailpit
                - --smtp-auth-accept-any
                - --smtp-auth-allow-insecure
              image: axllent/mailpit:v1.27.9
              name: mailpit
              ports:
                - containerPort: 8025
                  name: ui
                  protocol: TCP
                - containerPort: 1025
                  name: smtp
                  protocol: TCP
  27: |
    apiVersion: gateway.networking.k8s.io/v1
    kind: HTTPRoute
    metadata:
      name: mailpit
    spec:
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: k8sapi-gateway
          sectionName: websecure
      rules:
        - backendRefs:
            - group: ""
              kind: Service
              name: mailpit
              port: 8025
          matches:
            - path:
                type: PathPrefix
                value: /mailpit
  28: |
    apiVersion: v1
    kind: Service
    metadata:
      labels:
        app: mailpit
      name: mailpit
    spec:
      ports:
        - name: ui
          port: 8025
          protocol: TCP
          targetPort: ui
        - appProtocol: tcp
          name: smtp
          port: 1025
          protocol: TCP
          targetPort: smtp
      selector:
        app: mailpit
