# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Test provider-config-secret-job manifests
release:
  name: infra
  namespace: platform-mesh-system
tests:
- it: should not create Job resources when crossplane is disabled
  templates:
    - keycloak/crossplane/provider-config-secret-job.yaml
  set:
    crossplane:
      enabled: false
  asserts:
  - hasDocuments:
      count: 0

- it: should not create Job resources when externalSecrets is enabled
  templates:
    - keycloak/crossplane/provider-config-secret-job.yaml
  set:
    crossplane:
      enabled: true
    externalSecrets:
      enabled: true
  asserts:
  - hasDocuments:
      count: 0

- it: should create all resources when enabled with same namespace
  templates:
    - keycloak/crossplane/provider-config-secret-job.yaml
  set:
    crossplane:
      enabled: true
    externalSecrets:
      enabled: false
    keycloak:
      crossplane:
        providerConfig:
          name: keycloak-provider-config
          namespace: platform-mesh-system
      keycloakConfig:
        admin:
          username:
            value: keycloak-admin
        url: http://keycloak.platform-mesh-system.svc.cluster.local/keycloak
  asserts:
  - matchSnapshot: {}

- it: should create all resources when namespaces differ
  templates:
    - keycloak/crossplane/provider-config-secret-job.yaml
  set:
    crossplane:
      enabled: true
    externalSecrets:
      enabled: false
    keycloak:
      crossplane:
        providerConfig:
          name: keycloak-provider-config
          namespace: custom-namespace
      keycloakConfig:
        admin:
          username:
            value: keycloak-admin
        url: http://keycloak.platform-mesh-system.svc.cluster.local/keycloak
  asserts:
  - matchSnapshot: {}

- it: should have Job with correct annotations
  templates:
    - keycloak/crossplane/provider-config-secret-job.yaml
  set:
    crossplane:
      enabled: true
    externalSecrets:
      enabled: false
    keycloak:
      crossplane:
        providerConfig:
          name: keycloak-provider-config
          namespace: platform-mesh-system
      keycloakConfig:
        admin:
          username:
            value: keycloak-admin
        url: http://keycloak.platform-mesh-system.svc.cluster.local/keycloak
  asserts:
  - hasDocuments:
      count: 4
  - matchSnapshot:
      documentIndex: 3

- it: should have Job with correct configuration
  templates:
    - keycloak/crossplane/provider-config-secret-job.yaml
  set:
    crossplane:
      enabled: true
    externalSecrets:
      enabled: false
    keycloak:
      crossplane:
        providerConfig:
          name: keycloak-provider-config
          namespace: platform-mesh-system
      keycloakConfig:
        admin:
          username:
            value: keycloak-admin
        url: http://keycloak.platform-mesh-system.svc.cluster.local/keycloak
  asserts:
  - hasDocuments:
      count: 4
  - matchSnapshot:
      documentIndex: 3
