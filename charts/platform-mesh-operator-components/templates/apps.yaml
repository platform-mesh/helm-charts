{{ $values := .Values }}
{{- range $service, $config := .Values.services }}
{{- if $config.enabled }}
{{- if not (or $config.helmRepo $config.gitRepo) -}}
apiVersion: kro.run/v1alpha1
kind: OciRepoApp
metadata:
  name: {{ $service }}
  namespace: {{ $.Release.Namespace }}
spec:
  values: |-
    {{ $config.values | toYaml | nindent 4 }}
  targetNamespace: {{ $config.targetNamespace }}
  driftDetectionMode: enabled
  secretName: {{ $values.ociPullSecret }}
  componentName: {{ $values.ocm.componentName }}
  resourcePath: {{ default $service $config.resourcePath }}
---
{{ end -}}
{{- if $config.helmRepo  -}}
apiVersion: kro.run/v1alpha1
kind: HelmRepoApp
metadata:
  name: {{ $service }}
  namespace: {{ $.Release.Namespace }}
spec:
  values: |-
    {{ $config.values | toYaml | nindent 4 }}
  targetNamespace: {{ $config.targetNamespace }}
  driftDetectionMode: enabled
  {{- if and $config.helmRepo (and $config.dependsOn (ne $config.dependsOn "")) }}
  dependsOn: {{ $config.dependsOn }}
  {{- end }}
  secretName: {{ $values.ociPullSecret }}
  componentName: {{ $values.ocm.componentName }}
  resourcePath: {{ default $service $config.resourcePath }}
---
{{ end -}}
{{- if $config.gitRepo  -}}
apiVersion: kro.run/v1alpha1
kind: GitRepoApp
metadata:
  name: {{ $service }}
  namespace: {{ $.Release.Namespace }}
spec:
  values: |-
    {{ $config.values | toYaml | nindent 4 }}
  targetNamespace: {{ $config.targetNamespace }}
  driftDetectionMode: enabled
  secretName: {{ $values.ociPullSecret }}
  componentName: {{ $values.ocm.componentName }}
  resourcePath: {{ default $service $config.resourcePath }}
---
{{ end -}}
{{ end -}}
{{ end -}}
