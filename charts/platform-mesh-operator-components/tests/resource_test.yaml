# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Test the resource manifests
release:
  name: operator-components
  namespace: default
values:
  - ../test-values.yaml
tests:
- it: override referencePath
  template: ocm-resources.yaml
  documentSelector:
    path: metadata.name
    value: virtual-workspaces
  set:
    componentVersion:
      semver: 0.0.0
    ocm:
      interval: 3m
      referencePath:
       - name: platform-mesh
      component:
        create: true
        name: platform-mesh
      repo:
        create: true
        name: platform-mesh
    services:
      virtual-workspaces:
        enabled: true
        dependsOn:
          - name: istio-istiod
            namespace: default
        referencePath:
          - name: test
        ocm:
          component:
            name: comp-vw
          repo:
            name: repo-vw
  asserts:
    - equal:
        path: spec.resource.byReference.referencePath[0].name
        value: platform-mesh
    - equal:
        path: spec.resource.byReference.referencePath[1].name
        value: test
    - lengthEqual:
        path: spec.resource.byReference.referencePath
        count: 2
    - equal:
        path: spec.componentRef.name
        value: comp-vw
    - equal:
        path: spec.ocmConfig[0].name
        value: repo-vw


- it: default referencePath
  templates: 
    - ocm-resources.yaml
  documentSelector:
    path: metadata.name
    value: tracing
  set:
    componentVersion:
      semver: 0.0.0
    ocm:
      interval: 3m
      referencePath:
       - name: platform-mesh
      component:
        create: true
        name: platform-mesh
      repo:
        create: true
        name: platform-mesh
    services:
      tracing:
        enabled: true
  asserts:
    - equal:
        path: spec.resource.byReference.referencePath[0].name
        value: platform-mesh
    - equal:
        path: spec.resource.byReference.referencePath[1].name
        value: tracing
    - lengthEqual:
        path: spec.resource.byReference.referencePath
        count: 2
    - equal:
        path: spec.componentRef.name
        value: platform-mesh
    - equal:
        path: spec.ocmConfig[0].name
        value: platform-mesh

- it: image enabled resource
  template: ocm-image-resources.yaml
  asserts:
    - matchSnapshot: {}

- it: ocm resources
  template: ocm-resources.yaml
  asserts:
    - matchSnapshot: {}

- it: default referencePath oci-image-resources
  templates: 
    - ocm-image-resources.yaml
  documentSelector:
    path: metadata.name
    value: kcp-image
  set:
    componentVersion:
      semver: 0.0.0
    ocm:
      interval: 3m
      referencePath:
       - name: platform-mesh
      component:
        create: true
        name: apeiro
      repo:
        create: true
        name: apeirorepo
    services:
      infra:
        enabled: true
        imageResources:
          - name: kcp-image
            annotations:
              path: kcp.image.tag
              for: infra
              repo: oci
              artifact: image
            resource: image
            referencePath:
              - name: kcp
  asserts:
    - equal:
        path: spec.resource.byReference.referencePath[0].name
        value: platform-mesh
    - equal:
        path: spec.resource.byReference.referencePath[1].name
        value: kcp
    - lengthEqual:
        path: spec.resource.byReference.referencePath
        count: 2
    - equal:
        path: spec.componentRef.name
        value: apeiro
    - equal:
        path: spec.ocmConfig[0].name
        value: apeirorepo

- it: absoluteReferencePath oci-image-resources
  templates: 
    - ocm-image-resources.yaml
  documentSelector:
    path: metadata.name
    value: kcp-image
  set:
    componentVersion:
      semver: 0.0.0
    ocm:
      interval: 3m
      referencePath:
       - name: platform-mesh
      component:
        create: true
        name: apeiro
      repo:
        create: true
        name: apeirorepo
    services:
      infra:
        enabled: true
        imageResources:
          - name: kcp-image
            annotations:
              path: kcp.image.tag
              for: infra
              repo: oci
              artifact: image
            resource: image
            absoluteReferencePath:
              - name: compref1
              - name: compref2
  asserts:
    - equal:
        path: spec.resource.byReference.referencePath[0].name
        value: compref1
    - equal:
        path: spec.resource.byReference.referencePath[1].name
        value: compref2
    - lengthEqual:
        path: spec.resource.byReference.referencePath
        count: 2
    - equal:
        path: spec.componentRef.name
        value: apeiro
    - equal:
        path: spec.ocmConfig[0].name
        value: apeirorepo

- it: absoluteReferencePath ocm-resources
  templates:
    - ocm-resources.yaml
  documentSelector:
    path: metadata.name
    value: infra
  set:
    componentVersion:
      semver: 0.0.0
    ocm:
      interval: 3m
      referencePath:
       - name: platform-mesh
      component:
        create: true
        name: apeiro
      repo:
        create: true
        name: apeirorepo
    services:
      infra:
        enabled: true
        absoluteReferencePath:
          - name: compref1
          - name: compref2
  asserts:
    - equal:
        path: spec.resource.byReference.referencePath[0].name
        value: compref1
    - equal:
        path: spec.resource.byReference.referencePath[1].name
        value: compref2
    - lengthEqual:
        path: spec.resource.byReference.referencePath
        count: 2
    - equal:
        path: spec.componentRef.name
        value: apeiro
    - equal:
        path: spec.ocmConfig[0].name
        value: apeirorepo
