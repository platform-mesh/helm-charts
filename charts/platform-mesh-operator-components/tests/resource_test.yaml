# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Test the resource manifests
release:
  name: operator-components
  namespace: default
values:
  - ../test-values.yaml
tests:
- it: override referencePath
  template: ocm-resources.yaml
  documentSelector:
    path: metadata.name
    value: virtual-workspaces
  set:
    componentVersion:
      semver: 0.0.0
    ocm:
      interval: 3m
      referencePath:
       - name: platform-mesh
      component:
        create: true
        name: platform-mesh
      repo:
        create: true
        name: platform-mesh
    services:
      virtual-workspaces:
        enabled: true
        dependsOn:
          - name: istio-istiod
            namespace: default
        referencePath:
          - name: test
        ocm:
          component:
            name: comp-vw
          repo:
            name: repo-vw
  asserts:
    - equal:
        path: spec.resource.byReference.referencePath[0].name
        value: test
    - lengthEqual:
        path: spec.resource.byReference.referencePath
        count: 1
    - equal:
        path: spec.componentRef.name
        value: comp-vw
    - equal:
        path: spec.ocmConfig[0].name
        value: repo-vw


- it: default referencePath
  templates: 
    - ocm-resources.yaml
  documentSelector:
    path: metadata.name
    value: tracing
  set:
    componentVersion:
      semver: 0.0.0
    ocm:
      interval: 3m
      referencePath:
       - name: platform-mesh
      component:
        create: true
        name: platform-mesh
      repo:
        create: true
        name: platform-mesh
    services:
      tracing:
        enabled: true
  asserts:
    - equal:
        path: spec.resource.byReference.referencePath[0].name
        value: platform-mesh
    - equal:
        path: spec.resource.byReference.referencePath[1].name
        value: tracing
    - lengthEqual:
        path: spec.resource.byReference.referencePath
        count: 2
    - equal:
        path: spec.componentRef.name
        value: platform-mesh
    - equal:
        path: spec.ocmConfig[0].name
        value: platform-mesh

- it: image enabled resource
  template: ocm-image-resources.yaml
  asserts:
    - matchSnapshot: {}
