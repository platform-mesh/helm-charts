version: '3'

vars:
  LOCAL_BIN: bin
  CHARTS:
    sh: "printf '%s' $(ls -d charts/*/ | paste -sd ',' -)"
  CHANGED_CHARTS:
    sh: "git status --porcelain | grep '^M  charts/' | cut -d'/' -f2 | sort -u | sed 's|^|charts/|' | paste -sd ',' -"
  PACKAGED_CHARTS:
    sh: "mkdir -p oci/ && ls oci/ | sed 's/^/oci\\//g' | paste -sd ',' -"
  GOOS:
    sh: go env GOOS
  GOARCH:
    sh: go env GOARCH
  OCM_VERSION: 0.33.0
  COMPONENT_PRERELEASE_VERSION: "1.0.0"
  CUSTOM_LOCAL_COMPONENTS_CHART_PATHS:
    - account-operator: charts/account-operator
    - example-httpbin-operator: charts/example-httpbin-operator
    - extension-manager-operator: charts/extension-manager-operator
    - iam-service: charts/iam-service
    - iam-ui: charts/iam-ui
    - infra: charts/infra
    - kubernetes-graphql-gateway: charts/kubernetes-graphql-gateway
    - organization-idp: charts/organization-idp
    - platform-mesh-operator: charts/platform-mesh-operator
    - platform-mesh-operator-components: charts/platform-mesh-operator-components
    - platform-mesh-operator-infra-components: charts/platform-mesh-operator-infra-components
    - portal: charts/portal
    - rebac-authz-webhook: charts/rebac-authz-webhook
    - security-operator: charts/security-operator
    - virtual-workspaces: charts/virtual-workspaces
  COMPONENT_VERSION_FIX_DEPEDENCY_VERSIONS: []
    # - keycloak: 24.8.1
  CMD_SED:
    sh: |
      # Check if sed is GNU sed or BSD sed (GNU sed has --version, BSD sed doesn't)
      if sed --version >/dev/null 2>&1; then
        echo "sed -i"
      else
        echo "sed -i ''"
      fi

tasks:
  ## Setup
  setup:kube-lint:
    internal: true
    cmds:
      - mkdir -p $(pwd)/{{.LOCAL_BIN}}
      - test -s {{.LOCAL_BIN}}/kube-linter || GOBIN=$(pwd)/{{.LOCAL_BIN}} go install golang.stackrox.io/kube-linter/cmd/kube-linter@latest
      - chmod +x $(pwd)/{{.LOCAL_BIN}}/kube-linter
  setup:helm-docs:
    internal: true
    cmds:
      - test -s {{.LOCAL_BIN}}/helm-docs || GOBIN=$(pwd)/{{.LOCAL_BIN}} go install github.com/norwoodj/helm-docs/cmd/helm-docs@v1.14.2
  setup:mkcert:
    internal: true
    cmds:
      - test -s {{.LOCAL_BIN}}/mkcert || GOBIN=$(pwd)/{{.LOCAL_BIN}} go install filippo.io/mkcert@latest
      - export PATH=$(pwd)/{{.LOCAL_BIN}}:$PATH
  setup:ocm:
    internal: true
    cmds:
      - ./local-setup/scripts/ocm-setup.sh
  setup:mkbin:
    internal: true
    cmds:
      - mkdir -p $(pwd)/{{.LOCAL_BIN}}


  ## Development
  lint:
    deps: []
    cmds:
      - "ct lint --target-branch main --chart-dirs=charts --validate-maintainers=false --chart-repos=bitnami=https://charts.bitnami.com/bitnami,openfga=https://openfga.github.io/helm-charts"
  helmtest:
    cmds:
      - "for chart in $(echo {{.CHARTS}} | tr ',' ' '); do helm unittest $chart; done"
  helmtest-update:
    cmds:
      - "for chart in $(echo {{.CHARTS}} | tr ',' ' '); do helm unittest -u $chart; done"
  test:
    deps:
      - task: helmtest
  update-changed:
    deps:
      - task: docs
    cmds:
      - "for chart in $(echo {{.CHANGED_CHARTS}} | tr ',' ' '); do helm dependency update $chart && helm unittest -u $chart; done"
  update:
    deps:
      - task: docs
    cmds:
      - "for chart in $(echo {{.CHARTS}} | tr ',' ' '); do helm dependency update $chart; done"
  validate:
    cmds:
      - task: test
      - task: docs
      - task: update
      - task: lint
      - task: oci
  vulnerability:
    deps:
      - task: setup:kube-lint
    cmds:
      - "{{.LOCAL_BIN}}/kube-linter lint \"charts/\" --format \"plain\""
  docs:
    deps:
      - task: setup:helm-docs
    cmds:
      - "for chart in $(echo {{.CHARTS}} | tr ',' ' '); do {{.LOCAL_BIN}}/helm-docs --log-level=debug --chart-search-root $chart --template-files=../../docs-templates/header.md.gotmpl,README.md.gotmpl,../../docs-templates/footer.md.gotmpl --skip-version-footer=false; done"
  oci:
    cmds:
      - "rm oci/* || true"
      - task: helmpackage

  ocm:deploy:ociregistry:
    internal: true
    cmds:
      - |
        kind export kubeconfig -n platform-mesh
        # docs: https://github.com/twuni/docker-registry.helm
        helm repo add twuni https://twuni.github.io/docker-registry.helm || true
        helm repo update
        kubectl create ns registry || true
        helm upgrade --install oci-registry twuni/docker-registry -n registry --set service.port=443 --set tlsSecretName=domain-certificate --set image.repository=ghcr.io/distribution/distribution --set image.tag=3.0.0 --set ingress.enabled=false

        kubectl create secret generic domain-certificate -n registry \
          --from-file=tls.crt=./local-setup/scripts/certs/cert.crt \
          --from-file=tls.key=./local-setup/scripts/certs/cert.key \
          --from-file=ca.crt=./local-setup/scripts/certs/ca.crt \
          --type=kubernetes.io/tls --dry-run=client -oyaml | kubectl apply -f -
        
        kubectl wait --namespace registry \
          --for=condition=available deployment \
          --timeout=120s oci-registry-docker-registry

  ocm:build:custom-local-charts:
    deps:
      - task: setup:ocm
    cmds:
      - ./local-setup/scripts/ocm-build-local-charts.sh

  ocm:configure:tls:
    internal: true
    desc: Apply ocm-k8s-toolkit patch to support oci registry with self-signed certs
    cmds:
      - local-setup/scripts/configureOcmTls.sh

  ocm:build:component:
    aliases:
      - ocm:build
    cmds:
      - ./local-setup/scripts/ocm-build-component.sh

  ocm:deploy:transfer-pod:
    internal: true
    cmds:
      - |
        set -e
        echo "Transferring OCM transport archive to local registry from a pod..."
        kubectl delete pod ocm-transfer-pod --ignore-not-found=true || true
        kubectl run ocm-transfer-pod --image=ghcr.io/platform-mesh/images/ocmbuilder:pr-4 -- sleep infinity || true
        kubectl wait --namespace default --for=condition=Ready pod --timeout=480s ocm-transfer-pod
        kubectl exec -ti ocm-transfer-pod -- mkdir -p .ocm
        
        # configure RootCA truststore on the pod
        kubectl exec -ti ocm-transfer-pod -- openssl s_client -connect oci-registry-docker-registry.registry.svc.cluster.local:443 -showcerts </dev/null 2>/dev/null| openssl x509 -outform PEM > registry-ca.pem
        kubectl cp registry-ca.pem -n default ocm-transfer-pod:registry-ca.pem
        kubectl exec -ti ocm-transfer-pod -- sudo cp registry-ca.pem /usr/local/share/ca-certificates/local-oci-registry_root_ca.crt
        kubectl exec -ti ocm-transfer-pod -- sudo update-ca-certificates

  ocm:transfer:dir-to-local-oci:
    cmds:
      - cmd: kubectl exec -it ocm-transfer-pod -- ocm transfer ctf --overwrite .ocm/transport.ctf oci://oci-registry-docker-registry.registry.svc.cluster.local/platform-mesh
        ignore_error: true

  ocm:deploy:
    cmds:
      - task: ocm:deploy:ociregistry
      - task: ocm:deploy:transfer-pod
      - task: ocm:configure:tls

  ocm:kustomize:apply:
    aliases:
      - ocm:apply
    cmds:
      - kind export kubeconfig -n platform-mesh
      - |
        echo "Applying kustomize overlay to deploy platform-mesh, semver: {{ .COMPONENT_PRERELEASE_VERSION }}"
        yq -i '.spec.semver = "{{ .COMPONENT_PRERELEASE_VERSION }}"' local-setup/kustomize/overlays/ocm-prerelease/prerelease-component.yml

      - |
        kubectl apply -k local-setup/kustomize/overlays/ocm-prerelease
        echo "Applied kustomize overlay"
      - kubectl rollout restart deployment/ocm-k8s-toolkit-controller-manager -n ocm-system

  ocm:cleanup:
    cmds:
      - kind export kubeconfig -n platform-mesh
      - |
        rm registry-ca.pem
      - cmd: kubectl delete pod ocm-transfer-pod --ignore-not-found=true

  ocm:check-images:
    desc: Check which images are OCM-managed vs unmanaged on the cluster
    cmds:
      - ./local-setup/scripts/check-ocm-images.sh

  bump-local-setup-component-version:
    deps:
      - task: setup:ocm
    cmds:
      - |
        LATEST_VERSION=$({{ .LOCAL_BIN }}/ocm --config .ocm/config get componentversions --repo ghcr.io/platform-mesh github.com/platform-mesh/platform-mesh --latest -ojson | jq -r '.items[0].component.version')
        yq -i '.spec.semver = "'$LATEST_VERSION'"' local-setup/kustomize/components/ocm/component.yaml

  ocm:build-apply:iterate:
    cmds:
      - task: ocm:build:component
      - task: ocm:kustomize:apply
  
  ocm:update:constructor:
    cmds:
      - curl -o .ocm/component-constructor-prerelease.yaml https://raw.githubusercontent.com/platform-mesh/ocm/refs/heads/main/constructor/component-constructor.yaml
      - sed 's/name:\ github.com\/platform-mesh\/platform-mesh/name:\ github.com\/platform-mesh\/prerelease/' .ocm/component-constructor-prerelease.yaml > .ocm/component-constructor-prerelease.yaml.tmp && mv .ocm/component-constructor-prerelease.yaml.tmp .ocm/component-constructor-prerelease.yaml

  test:portal-e2e:
    cmds:
      - |
          pushd local-setup/e2e
          npm install
          npm ci
          npx playwright install
          npx playwright test test-register-and-navigate.test.ts
          popd

  local-setup:
    deps:
      - task: setup:mkcert
    vars:
      FLAGS: '{{.FLAGS | default ""}}'
    cmds:
      - |
        if kind get clusters 2>/dev/null | grep -q "^platform-mesh$"; then
          read -r -p "Are you sure you want to delete the cluster? [y/N] " response && if [ "$response" != "y" ]; then echo "Aborted."; exit 1; fi
          kind delete cluster --name platform-mesh
        fi
        ./local-setup/scripts/start.sh {{.FLAGS}}

  local-setup:iterate:
    deps:
      - task: setup:mkcert
    vars:
      FLAGS: '{{.FLAGS | default ""}}'
    cmds:
      - ./local-setup/scripts/start.sh {{.FLAGS}}

  # Convenience aliases with common flag combinations
  local-setup:cached:
    cmds:
      - task: local-setup
        vars: {FLAGS: "--cached"}

  local-setup:cached:iterate:
    cmds:
      - task: local-setup:iterate
        vars: {FLAGS: "--cached"}

  local-setup:example-data:
    cmds:
      - task: local-setup
        vars: {FLAGS: "--example-data"}

  local-setup:example-data:iterate:
    cmds:
      - task: local-setup:iterate
        vars: {FLAGS: "--example-data"}

  local-setup:cached:example-data:
    cmds:
      - task: local-setup
        vars: {FLAGS: "--cached --example-data"}

  local-setup:cached:example-data:iterate:
    cmds:
      - task: local-setup:iterate
        vars: {FLAGS: "--cached --example-data"}

  local-setup:prerelease:
    cmds:
      - task: local-setup
        vars: {FLAGS: "--prerelease"}

  local-setup:prerelease:iterate:
    cmds:
      - task: local-setup:iterate
        vars: {FLAGS: "--prerelease"}

  local-setup:prerelease:example-data:
    cmds:
      - task: local-setup
        vars: {FLAGS: "--prerelease --example-data"}

  local-setup:prerelease:example-data:iterate:
    cmds:
      - task: local-setup:iterate
        vars: {FLAGS: "--prerelease --example-data"}

  local-setup:cached:prerelease:
    cmds:
      - task: local-setup
        vars: {FLAGS: "--cached --prerelease"}

  local-setup:cached:prerelease:iterate:
    cmds:
      - task: local-setup:iterate
        vars: {FLAGS: "--cached --prerelease"}

  local-setup:cached:prerelease:example-data:
    cmds:
      - task: local-setup
        vars: {FLAGS: "--cached --prerelease --example-data"}

  local-setup:cached:prerelease:example-data:iterate:
    cmds:
      - task: local-setup:iterate
        vars: {FLAGS: "--cached --prerelease --example-data"}
