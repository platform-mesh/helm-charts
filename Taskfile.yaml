version: '3'

vars:
  LOCAL_BIN: bin
  CHARTS:
    sh: "printf '%s' $(ls -d charts/*/ | paste -sd ',' -)"
  CHANGED_CHARTS:
    sh: "git status --porcelain | grep '^ M charts/' | cut -d'/' -f2 | sort -u | sed 's|^|charts/|' | paste -sd ',' -"
  PACKAGED_CHARTS:
    sh: "ls oci/ | sed 's/^/oci\\//g' | paste -sd ',' -"
  GOOS:
    sh: go env GOOS
  GOARCH:
    sh: go env GOARCH
  OCM_VERSION: 0.24.0
tasks:
  ## Setup
  setup:kube-lint:
    internal: true
    cmds:
      - mkdir -p $(pwd)/{{.LOCAL_BIN}}
      - test -s {{.LOCAL_BIN}}/kube-linter || GOBIN=$(pwd)/{{.LOCAL_BIN}} go install golang.stackrox.io/kube-linter/cmd/kube-linter@latest
      - chmod +x $(pwd)/{{.LOCAL_BIN}}/kube-linter
  setup:helm-docs:
    internal: true
    cmds:
      - test -s {{.LOCAL_BIN}}/helm-docs || GOBIN=$(pwd)/{{.LOCAL_BIN}} go install github.com/norwoodj/helm-docs/cmd/helm-docs@v1.14.2
  setup:mkcert:
    internal: true
    cmds:
      - test -s {{.LOCAL_BIN}}/mkcert || GOBIN=$(pwd)/{{.LOCAL_BIN}} go install filippo.io/mkcert@latest
      - export PATH=$(pwd)/{{.LOCAL_BIN}}:$PATH

  setup:ocm:
    internal: true
    cmds:
      - test -s {{.LOCAL_BIN}}/ocm || (curl -o {{.LOCAL_BIN}}/ocm.tar.gz -sSL https://github.com/open-component-model/ocm/releases/download/v{{ .OCM_VERSION }}/ocm-{{ .OCM_VERSION }}-{{ .GOOS }}-{{ .GOARCH }}.tar.gz && tar -xzf {{ .LOCAL_BIN }}/ocm.tar.gz -C {{ .LOCAL_BIN }} && rm {{ .LOCAL_BIN }}/ocm.tar.gz && chmod +x {{.LOCAL_BIN}}/ocm && chmod 755 {{.LOCAL_BIN}}/ocm)
  ## Development
  lint:
    deps: []
    cmds:
      - "ct lint --target-branch main --chart-dirs=charts --validate-maintainers=false --chart-repos=bitnami=https://charts.bitnami.com/bitnami,openfga=https://openfga.github.io/helm-charts"
  helmtest:
    cmds:
      - "for chart in $(echo {{.CHARTS}} | tr ',' ' '); do helm unittest $chart; done"
  helmtest-update:
    cmds:
      - "for chart in $(echo {{.CHARTS}} | tr ',' ' '); do helm unittest -u $chart; done"
  test:
    deps:
      - task: helmtest
  update-changed:
    deps:
      - task: docs
    cmds:
      - "for chart in $(echo {{.CHANGED_CHARTS}} | tr ',' ' '); do helm dependency update $chart && helm unittest -u $chart; done"
  update:
    deps:
      - task: docs
    cmds:
      - "for chart in $(echo {{.CHARTS}} | tr ',' ' '); do helm dependency update $chart; done"
  validate:
    cmds:
      - task: test
      - task: docs
      - task: update
      - task: lint
      - task: oci
  vulnerability:
    deps:
      - task: setup:kube-lint
    cmds:
      - "{{.LOCAL_BIN}}/kube-linter lint \"charts/\" --format \"plain\""
  docs:
    deps:
      - task: setup:helm-docs
    cmds:
      - "for chart in $(echo {{.CHARTS}} | tr ',' ' '); do {{.LOCAL_BIN}}/helm-docs --log-level=debug --chart-search-root $chart --template-files=../../docs-templates/header.md.gotmpl,README.md.gotmpl,../../docs-templates/footer.md.gotmpl --skip-version-footer=false; done"
  helmpackage:
    cmds:
      - "for chart in $(echo {{.CHARTS}} | tr ',' ' '); do helm package $chart -d oci/; done"
  helmpush:
    deps:
      - task: helmpackage
    cmds:
      - "for chart in $(echo {{.PACKAGED_CHARTS}} | tr ',' ' '); do helm push $chart oci://localhost:5000/platform-mesh; done"
  oci:
    cmds:
      - "rm oci/* || true"
      - task: helmpackage
  local-setup:iterate:
    cmds:
      - ./local-setup/scripts/start.sh
  local-setup:
    deps:
      - task: setup:mkcert
    cmds:
      - |
        read -r -p "Are you sure you want to delete the cluster? [y/N] " response && if [ "$response" != "y" ]; then echo "Aborted."; exit 1; fi
        kind delete cluster --name platform-mesh
        ./local-setup/scripts/start.sh

  local-setup-cached:
    deps:
      - task: setup:mkcert
    cmds:
      - read -r -p "Are you sure you want to delete the cluster? [y/N] " response && if [ "$response" != "y" ]; then echo "Aborted."; exit 1; fi
      - kind delete cluster --name platform-mesh
      - ./local-setup/scripts/start.sh --cached

  local-setup-cached:iterate:
    cmds:
      - ./local-setup/scripts/start.sh --cached

  local-setup-start-docker-registries:
    cmds:
      - docker run -d --name proxy-quay --restart=always --net=kind -e REGISTRY_PROXY_REMOTEURL=https://quay.io registry:2
      - docker run -d --name proxy-ghcr --restart=always --net=kind -e REGISTRY_PROXY_REMOTEURL=https://ghcr.io registry:2
      - docker run -d --name proxy-k8s-io --restart=always --net=kind -e REGISTRY_PROXY_REMOTEURL=https://registry.k8s.io registry:2

  bump-component-versions:
    deps: [setup:ocm]
    cmds:
      - |
        COMP_VERSION_JSON=$(bin/ocm get componentversions github.com/platform-mesh/platform-mesh --latest --repo ghcr.io/platform-mesh -o json)
        SERVICES=$(echo ''$COMP_VERSION_JSON'' | jq -r '.items[0] | .component.componentReferences[] | .name')
        COMPONENT_VERSION=$(echo ''$COMP_VERSION_JSON'' | jq -r '.items[0] | .component["version"]')
        echo "Bumping component version to $COMPONENT_VERSION"
        yq -i '.componentVersion.semver = "'$COMPONENT_VERSION'"' charts/platform-mesh-operator-components/values.yaml

  bump-local-setup-component-version:
    cmds:
      - |
        LATEST_VERSION=$(ocm get componentversions --repo ghcr.io/platform-mesh github.com/platform-mesh/platform-mesh --latest -ojson | jq -r '.items[0].component.version')
        yq -i '.spec.semver = "'$LATEST_VERSION'"' local-setup/kustomize/components/ocm-component/component.yaml