apiVersion: core.platform-mesh.io/v1alpha1
kind: PlatformMesh
metadata:
  name: platform-mesh
  namespace: platform-mesh-system
spec:
  exposure:
    port: 8443
  ocm:
    repo:
      name: platform-mesh
    component:
      name: platform-mesh
    referencePath: []
  featureToggles:
   - name: feature-enable-getting-started
   - name: feature-disable-email-verification
   - name: feature-accounts-in-accounts
  values:
    keycloak:
      enabled: true
      values:
        service:
          clusterIP: 10.96.0.110
        resources:
          limits:
            cpu: "2"
            ephemeral-storage: 2Gi
            memory: 2Gi
          requests:
            cpu: 750m
            ephemeral-storage: 50Mi
            memory: 1Gi
    infra:
      values:
        cors:
          enabled: true
          accessControlAllowOriginList:
          - "http://localhost:4200"
          - "http://localhost:4300"
          - "http://*.localhost:4200"
          - "http://*.localhost:4300"
          - "https://portal.localhost:8443"
          - "https://*.portal.localhost:8443"
        mailpit:
          enabled: true
        hostAliases:
          enabled: true
          entries:
            - ip: "10.96.188.4"
              hostnames:
                - "localhost"
                - "portal.localhost"
        kcp:
          external:
            hostname: localhost
          istio:
            hosts:
              - localhost
          frontProxy:
            clusterIP: "10.96.0.100"
        gatewayApi:
          main:
            gateway:
              hostnames:
                - "portal.localhost"
                - "*.portal.localhost"
          passThrough:
            gateway:
              hostname: localhost
        keycloak:
          gatewayApi:
            hostnames:
              - portal.localhost
            filters:
            - type: RequestHeaderModifier
              requestHeaderModifier:
                set:
                  - name: Host
                    value: portal.localhost
          crossplane:
            realm:
              verifyEmail: false
              smtpServer:
                - host: mailpit.platform-mesh-system.svc.cluster.local
                  port: "1025"
                  from: noreply@portal.localhost
            clients:
              welcome:
                validRedirectUris:
                  - "http://localhost:8000/callback*"
                  - "http://localhost:4300/callback*"
                  - "https://*"
    security-operator:
      values:
        log:
          noJson: true
        fga:
          extraArgs:
            - --idp-smtp-server=mailpit.platform-mesh-system.svc.cluster.local
            - --idp-smtp-port=1025
            - --idp-from-address=keycloak@portal.localhost
        initializer:
          extraArgs:
            - --domain-ca-lookup
            # remove arguments below when the operator and the portal are ready
            - --idp-smtp-server=mailpit.platform-mesh-system.svc.cluster.local
            - --idp-smtp-port=1025
            - --idp-from-address=keycloak@portal.localhost
        caSecret: domain-certificate-ca
        hostAliases:
          enabled: true
    portal:
      enabled: true
      values:
        gatewayApi:
          httpRoute:
            hostnames:
              - "portal.localhost"
              - "*.portal.localhost"
        extraEnvVars:
          - name: OPENMFP_PORTAL_CONTEXT_IAM_SERVICE_API_URL
            value: https://${org-subdomain}{{ .Values.baseDomainPort }}/iam/graphql
          - name: OPENMFP_PORTAL_CONTEXT_CRD_GATEWAY_API_URL
            value: "https://${org-subdomain}{{ .Values.baseDomainPort }}/api/kubernetes-graphql-gateway/root:orgs:${org-name}/graphql"
          - name: NODE_EXTRA_CA_CERTS
            value: /etc/ssl/certs/domain-ca.crt
        extraVolumes:
          - name: domain-ca
            secret:
              secretName: domain-certificate-ca
        extraVolumeMounts:
          - name: domain-ca
            mountPath: /etc/ssl/certs/domain-ca.crt
            subPath: tls.crt
            readOnly: true
        hostAliases:
          enabled: true
          entries:
            - ip: "10.96.188.4"
              hostnames:
                - "localhost"
                - "portal.localhost"
    openfga:
      enabled: true
      values:
        datastore:
          uri: "postgres://postgres:password@openfga-postgres.platform-mesh-system.svc.cluster.local:5432/postgres?sslmode=disable"
        postgresql:
          auth:
            postgresPassword: password
            database: postgres
    marketplace-ui:
      enabled: true
    iam-service:
      values:
        extraArgs:
          - --no-json
        cors:
          enabled: true
        exposure:
          hostnames:
            - "portal.localhost"
            - "*.portal.localhost"
        keycloak:
          baseUrl: https://portal.localhost:8443/keycloak
        hostAliases:
          enabled: true
          items:
            - ip: 10.96.188.4
              hostnames:
                - portal.localhost
                - localhost
    iam-ui:
      values:
        exposure:
          hostnames:
            - "portal.localhost"
            - "*.portal.localhost"
    kubernetes-graphql-gateway:
      values:
        gatewayApi:
          httpRoute:
            hostnames:
              - "portal.localhost"
              - "*.portal.localhost"
            filters:
            - type: URLRewrite
              urlRewrite:
                path:
                  type: ReplacePrefixMatch
                  replacePrefixMatch: /
            - type: RequestHeaderModifier
              requestHeaderModifier:
                set:
                - name: Host
                  value: "portal.localhost"
    virtual-workspaces:
      values:
        cert:
          extraDnsNames: [localhost]
