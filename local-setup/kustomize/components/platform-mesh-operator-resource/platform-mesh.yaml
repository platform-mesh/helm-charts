apiVersion: core.platform-mesh.io/v1alpha1
kind: PlatformMesh
metadata:
  name: platform-mesh
  namespace: platform-mesh-system
spec:
  exposure:
    port: 8443
  # renovate: datasource=docker registryUrl=https://ghcr.io depName=ghcr.io/platform-mesh/helm-charts/platform-mesh-operator-components
  chartVersion: 0.11.72
  values:
    istio-gateway:
      enabled: true
      targetNamespace: istio-system
      values:
        service:
          type: None
    keycloak:
      enabled: true
      values:
        service:
          clusterIP: 10.96.0.110
          # global:
          #   imageRegistry: ghcr.io
          #   imagePullSecrets:
          #     - github
          #   security:
          #     allowInsecureImages: true
          # image:
          #   registry: ghcr.io
          #   repository: platform-mesh/images/bitnami/keycloak
          #   tag: 26.3.2-debian-12-r0
          # postgresql:
          #   global:
          #     imageRegistry: ghcr.io
          #     imagePullSecrets:
          #       - github
          #   image:
          #     registry: ghcr.io
          #     repository: platform-mesh/images/bitnami/postgresql
          #     tag: 17.4.0-debian-12-r17
    crossplane:
      values:
        provider:
          packages:
            - xpkg.upbound.io/crossplane-contrib/provider-keycloak:v1.9.2
    infra:
      values:
        hostAliases:
          enabled: true
        kcp:
          webhook:
            enabled: true
            # TODO this should be set by the operator
            caData: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUREakNDQWZhZ0F3SUJBZ0lRVitUQmZDcFVyN1gvV3lRSkZ5Q1o0ekFOQmdrcWhraUc5dzBCQVFzRkFEQWgKTVI4d0hRWURWUVFERXhaeVpXSmhZeTFoZFhSb2VpMTNaV0pvYjI5ckxXTmhNQjRYRFRJMU1Ea3dNVEE1TlRBeQpNVm9YRFRJMU1URXpNREE1TlRBeU1Wb3dJVEVmTUIwR0ExVUVBeE1XY21WaVlXTXRZWFYwYUhvdGQyVmlhRzl2CmF5MWpZVENDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFOOFFscXhLd2NOOFQ0ckEKVDNUU2QyTkJTZzdjb1BhdUZkRCt6RXRVQWwwM0t6MXNCaW9vOGYrNno5bHoyZnVtRUI0VS9XdVp1YW5WaDIzcgpyRDNBMkREa1I5YzNwWmsxN2NPOU5makxwMTcvWjhNK2FLcWtzNnlQZ3NteTZOQWRFbnJsekxyblBHUjhnRW93CnZKMkQwVjlZV09iclJwdnM3dk41djNJd25ybms3UEhwOTFxSmVHVWhCbFZrREtTbldEYTBmLzQ2Y2tDTXcyOWgKenp2YmFEWEJ3WG5KVFVObS9nU2VaUGFFNUQxYzFGc1ovWDZ4cGRXN1B5OENkVXpPNVUwcGdtTnBPdk9zcytvNgp6amRTTkIwWk5nK3FrQy9lWHVmVUFpa1MzNUNPQmZrS2dwU1M0a3NJbEpldlJYa1N2by9XUXo2ZmM0dE5qbUFUCldZejVvMDBDQXdFQUFhTkNNRUF3RGdZRFZSMFBBUUgvQkFRREFnS2tNQThHQTFVZEV3RUIvd1FGTUFNQkFmOHcKSFFZRFZSME9CQllFRklBcUtONFRMbmxxNG0yOHA5VUgyakpySlI4dk1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQgpBUUN5M09rUlI0aU9NMitocGxQcTBvZm1oV0gxTUI1bFpuT3UyRkp2WDF2cHh2czYyUUlZT2dtZWpPZU82a1UrCkdBRnhHTEl0MmYvbktxTjRMYjNTNTh6N1lwaXd1L3NUZmlzYnRRVHFwNjA1UHQvNSs2Q0k3MjM3QTJLYkdpMFQKSkp2OXVXcmVwUFpGN2NLRWtMV1piMFpLKzd4US9vbHNsbnZtUUlMcVVjWi80dGNxZy9HYXkweWFSM3IrdERQTAorU0cwekY1UFlLOGhQczdsQkk4YmxDYVlxOWF1bE9iMDNjS2xWZllQZkIzbkdyekNLbUU3dlg4a3BVZjVLeGphCnlIZHJMdVdsclpwNTJmT2VRMjFic2dZUlUydndtK1JpaHhFMExoamdHVmpWOFpOY1Y4K2hzeDIzWXdUclNxN2QKM1pZbmNTRi9nTEEzSWIrKzFaaGpUVjdICi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"
          frontProxy:
            clusterIP: "10.96.0.100"
        keycloak:
          crossplane:
            clients:
              default:
                validRedirectUris:
                  - "http://localhost:8000/callback*"
                  - "http://localhost:4300/callback*"
                  - "https://portal.dev.local:8443/callback*"
    observability:
      enabled: false
    kcp-operator:
      enabled: true
      values:
        image:
          repository: ghcr.io/kcp-dev/kcp-operator
          #TODO this is needed until the latest changes are released like https://github.com/kcp-dev/kcp-operator/pull/89 and https://github.com/kcp-dev/kcp-operator/pull/88
          tag: "main"
          pullPolicy: IfNotPresent
    marketplace-ui:
      enabled: false
      values:
        istio:
          virtualService:
            hosts:
              - "portal.dev.local"
    iam-ui:
      enabled: false
      values:
        istio:
          virtualService:
            hosts:
              - "portal.dev.local"
    iam-service:
      enabled: false
    security-operator:
      values:
        hostAliases:
          enabled: true
          items:
            - ip: 10.96.0.100
              hostnames:
                - kcp.api.portal.dev.local
    portal:
      enabled: true
      values:
        extraEnvVars:
          - name: OPENMFP_PORTAL_CONTEXT_CRD_GATEWAY_API_URL
            value: "https://${org-subdomain}portal.dev.local:8443/api/kubernetes-graphql-gateway/root:orgs:${org-name}/graphql"
          - name: OPENMFP_PORTAL_CONTEXT_IAM_SERVICE_API_URL
            value: "https://portal.dev.local:8443/iam/query"
          - name: OPENMFP_PORTAL_CONTEXT_IAM_ENTITY_CONFIG
            value: '{"account":{"contextProperty":"entityId"}}'
          - name: NODE_EXTRA_CA_CERTS
            value: /etc/ssl/certs/domain-ca.crt
        extraVolumes:
          - name: domain-ca
            secret:
              secretName: domain-certificate-ca
        extraVolumeMounts:
          - name: domain-ca
            mountPath: /etc/ssl/certs/domain-ca.crt
            subPath: tls.crt
            readOnly: true
        deployment:
          hostAliases:
            - ip: "10.96.188.4"
              hostnames:
                - "portal.dev.local"
        virtualService:
          hosts:
            - "portal.dev.local"
        trust:
          default:
            tokenUrl: https://portal.dev.local:8443/keycloak/realms/default/protocol/openid-connect/token
            #     # -- base domains
            #     baseDomains: "portal.dev.local"
            #     # -- discovery endpoint. If specified (different than ""), authDomain and tokenUrl are not required
            #     #  discoveryEndpoint: ""
            #     # -- auth domain (if discoveryEndpoint is not specified)
            #     authDomain: http://localhost:8000/keycloak/realms/platform-mesh/protocol/openid-connect/auth
            #     # -- token url (if discoveryEndpoint is not specified)
            #     tokenUrl: http://keycloak/keycloak/realms/platform-mesh/protocol/openid-connect/token
            #     # -- oidc client secret name
            #     oidcClientSecretName: openmfp-client
            #     # -- login audience
            #     loginAudience: platform-mesh
            #     # -- secret key reference
            #     secretKeyRef: attribute.client_secret
            #     # -- ContentConfiguration validator api url
            #     contentConfigurationValidatorApiUrl: http://extension-manager-operator-server.platform-mesh-system.svc.cluster.local:8088/validate
    openfga:
      enabled: true
      values:
        datastore:
          uri: "postgres://postgres:password@openfga-postgres.platform-mesh-system.svc.cluster.local:5432/postgres?sslmode=disable"
        postgresql:
          auth:
            postgresPassword: password
            database: postgres
        telemetry:
          trace:
            enabled: true
            otlp:
              endpoint: observability-opentelemetry-collector.observability.svc.cluster.local:4317
              tls:
                enabled: false
    virtual-workspaces:
      values:
        virtualWorkspaceSecretName: virtual-workspaces-cert
        deployment:
          serverUrl: "https://frontproxy-front-proxy.platform-mesh-system:6443"
          resourceSchemaName: "v250704-6d57f16.contentconfigurations.ui.platform-mesh.io"
          resourceSchemaWorkspace: "root:platform-mesh-system"
          providerWorkspaceId: 25qr66v5qo0bev1m
          providerMetadataVirtualWorkspacePath: /services/apiexport/25qr66v5qo0bev1m/core.platform-mesh.io
          apiExportVirtualWorkspacePath: /services/apiexport/25qr66v5qo0bev1m/core.platform-mesh.io
    kubernetes-graphql-gateway:
      enabled: true
      values:
        listener:
          virtualWorkspacesConfig:
            content:
              virtualWorkspaces:
                - kubeconfig: /app/kubeconfig/kubeconfig
                  name: contentconfigurations
                  url: https://frontproxy-front-proxy.platform-mesh-system:6443/services/contentconfigurations
                  # - kubeconfig: /app/kubeconfig/kubeconfig
                  #   name: marketplace
                  #   url: https://frontproxy-front-proxy.platform-mesh-system:6443/services/marketplace
            enabled: true
