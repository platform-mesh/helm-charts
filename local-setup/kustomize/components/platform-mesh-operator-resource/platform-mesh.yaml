apiVersion: core.platform-mesh.io/v1alpha1
kind: PlatformMesh
metadata:
  name: platform-mesh
  namespace: platform-mesh-system
spec:
  exposure:
    port: 8443
  # renovate: datasource=docker registryUrl=https://ghcr.io depName=ghcr.io/platform-mesh/helm-charts/platform-mesh-operator-components
  chartVersion: 0.11.64
  values:
    istio-gateway:
      enabled: true
      targetNamespace: istio-system
      values:
        service:
          type: None
    keycloak:
      enabled: true
      values:
        service:
          clusterIP: 10.96.0.110
          #        crossplane:
          #          clients:
          #            default:
          #              validRedirectUris:
          #                - "https://portal.dev.local:8443/callback*"
          #                - "http://localhost:4300/callback*"
          #        keycloakConfig:
          #          url: http://keycloak.platform-mesh-system.svc.cluster.local/keycloak
    crossplane:
      values:
        provider:
          packages:
            - xpkg.upbound.io/crossplane-contrib/provider-keycloak:v1.9.2
    infra:
      values:
        hostAliases:
          enabled: true
        kcp:
          frontProxy:
            clusterIP: "10.96.0.100"
        keycloak:
          crossplane:
            clients:
              default:
                validRedirectUris:
                  - "http://localhost:8000/callback*"
                  - "http://localhost:4300/callback*"
                  - "https://portal.dev.local:8443/callback*"
    observability:
      enabled: false
    kcp-operator:
      enabled: true
      #    kcp:
      #      enabled: false
      #      values:
      #        istio:
      #          hosts:
      #            - kcp.api.portal.dev.local
      #        kcp:
      #          oidc:
      #            caSecretName: domain-certificate-ca
      #          externalHostname: kcp.api.portal.dev.local
      #          certificates:
      #            dnsNames:
      #              - localhost
      #              - kcp.api.portal.dev.local
      #              - virtual-workspaces.platform-mesh-system
      #          kcp:
      #            hostAliases:
      #              enabled: true
      #              values:
      #                - ip: "10.96.0.100"
      #                  hostnames:
      #                    - "kcp.api.portal.dev.local"
      #          kcpFrontProxy:
      #            hostAliases:
      #              enabled: true
      #              values:
      #                - ip: "10.96.188.4"
      #                  hostnames:
      #                    - "portal.dev.local"
      #            service:
      #              clusterIP: "10.96.0.100"
      #            monitoring:
      #              serviceMonitor:
      #                enabled: false
      #        webhook:
      #          server: https://rebac-authz-webhook.platform-mesh-system.svc.cluster.local:9443/authz
    marketplace-ui:
      enabled: false
      values:
        istio:
          virtualService:
            hosts:
              - "portal.dev.local"
    iam-ui:
      enabled: false
      values:
        istio:
          virtualService:
            hosts:
              - "portal.dev.local"
    iam-service:
      enabled: false
    security-operator:
      values:
        hostAliases:
          enabled: true
          items:
            - ip: 10.96.0.100
              hostnames:
                - kcp.api.portal.dev.local
    portal:
      enabled: true
      values:
        extraEnvVars:
          - name: DEFAULT_PORTAL_CONTEXT_CRD_GATEWAY_API_URL
            value: "https://portal.dev.local:8443/api/kubernetes-graphql-gateway/root:orgs:default/graphql"
          - name: NODE_EXTRA_CA_CERTS
            value: /etc/ssl/certs/domain-ca.crt
        extraVolumes:
          - name: domain-ca
            secret:
              secretName: domain-certificate-ca
        extraVolumeMounts:
          - name: domain-ca
            mountPath: /etc/ssl/certs/domain-ca.crt
            subPath: tls.crt
            readOnly: true
        deployment:
          hostAliases:
            - ip: "10.96.188.4"
              hostnames:
                - "portal.dev.local"
    openfga:
      enabled: true
      values:
        datastore:
          uri: "postgres://postgres:password@openfga-postgres.platform-mesh-system.svc.cluster.local:5432/postgres?sslmode=disable"
        postgresql:
          auth:
            postgresPassword: password
            database: postgres
        telemetry:
          trace:
            enabled: true
            otlp:
              endpoint: observability-opentelemetry-collector.observability.svc.cluster.local:4317
              tls:
                enabled: false
    kubernetes-graphql-gateway:
      enabled: true
    virtual-workspaces:
      values:
        deployment:
          providerWorkspaceId: 2ujbct7rh0nxq7q8
          providerMetadataVirtualWorkspacePath: /services/apiexport/2ujbct7rh0nxq7q8/core.platform-mesh.io
          apiExportVirtualWorkspacePath: /services/apiexport/2ujbct7rh0nxq7q8/core.platform-mesh.io
          serverUrl: "https://frontproxy-front-proxy.platform-mesh-system:9443"
