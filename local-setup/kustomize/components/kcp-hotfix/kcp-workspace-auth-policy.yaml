apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: kcp-workspace-authentication-feature-gate
  annotations:
    policies.kyverno.io/title: KCP WorkspaceAuthentication Feature Gate
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/subject: Deployment
    policies.kyverno.io/description: >-
      Ensures the root-kcp deployment includes the WorkspaceAuthentication feature gate.
spec:
  validationFailureAction: Enforce
  mutateExistingOnPolicyUpdate: true
  background: true
  rules:
    - name: scale-down-operator
      match:
        any:
          - resources:
              kinds:
                - Deployment
              names:
                - kcp-operator
              namespaces:
                - kcp-operator
      mutate:
        targets:
          - apiVersion: apps/v1
            kind: Deployment
            name: kcp-operator
            namespace: kcp-operator
        patchesJson6902: |-
          - op: replace
            path: /spec/replicas
            value: 0

    - name: ensure-workspace-authentication-feature-gate-root
      match:
        any:
          - resources:
              kinds:
                - Deployment
              names:
                - root-kcp
              namespaces:
                - platform-mesh-system
      preconditions:
        all:
          - key: "{{ request.object.spec.template.spec.containers[0].args[?contains(@, '--feature-gates=WorkspaceAuthentication=true')] | length(@) }}"
            operator: Equals
            value: 0
          - key: "{{ request.object.spec.template.spec.containers[0].args[?contains(@, '--shard-virtual-workspace-url=')] | length(@) }}"
            operator: Equals
            value: 0
      mutate:
        targets:
          - apiVersion: apps/v1
            kind: Deployment
            name: root-kcp
            namespace: platform-mesh-system
        patchesJson6902: |-
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --feature-gates=WorkspaceAuthentication=true
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --shard-virtual-workspace-url=https://kcp.api.portal.dev.local:8443
    - name: ensure-workspace-authentication-feature-gate-frontproxy
      match:
        any:
          - resources:
              kinds:
                - Deployment
              names:
                - frontproxy-front-proxy
              namespaces:
                - platform-mesh-system
      preconditions:
        any:
          - key: "{{ request.object.spec.template.spec.containers[0].args[?contains(@, '--feature-gates=WorkspaceAuthentication=true')] | length(@) }}"
            operator: Equals
            value: 0
      mutate:
        targets:
          - apiVersion: apps/v1
            kind: Deployment
            name: frontproxy-front-proxy
            namespace: platform-mesh-system
        patchesJson6902: |-
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --feature-gates=WorkspaceAuthentication=true
