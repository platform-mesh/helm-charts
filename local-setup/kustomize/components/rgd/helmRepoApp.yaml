apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: helm-repo-app
spec:
  schema:
    apiVersion: v1alpha1
    kind: HelmRepoApp
    spec:
      values: string
      resourcePath: string | required=true
      targetNamespace: string | required=true default="platform-mesh-system"
      driftDetectionMode: string | required=true default="enabled"
      createNamespace: boolean | required=true default="false"
      secretName: string | required=true default="platform-mesh-system"
      componentName: string | required=true default="platform-mesh"
      dependsOn: string | required=true default="kro"
    types:
      dependsOn:
        name: string
        namespace: string
  resources:
    - id: resourceChart
      template:
        apiVersion: delivery.ocm.software/v1alpha1
        kind: Resource
        metadata:
          name: ${schema.metadata.name}
        spec:
          componentRef:
            name: ${schema.spec.componentName}
          resource:
            byReference:
              resource:
                name: chart
              referencePath:
                - name: ${schema.spec.resourcePath}
          interval: 1m
          ocmConfig:
            - kind: Secret
              name: ${schema.spec.secretName}
    - id: helmrepo
      template:
        apiVersion: source.toolkit.fluxcd.io/v1
        kind: HelmRepository
        metadata:
          name: ${schema.metadata.name}
          namespace: default
        spec:
          interval: 5m0s
          url: ${resourceChart.status.reference.registry}
    - id: helmrelease
      template:
        apiVersion: helm.toolkit.fluxcd.io/v2
        kind: HelmRelease
        metadata:
          name: ${schema.metadata.name}
        spec:
          releaseName: ${schema.metadata.name}
          targetNamespace: ${schema.spec.targetNamespace}
          interval: 1m
          timeout: 5m
          dependsOn:
            - name: ${schema.spec.dependsOn}
              namespace: default
          install:
            createNamespace: true
          chart:
            spec:
              chart: ${resourceChart.status.reference.repository}
              version: "${resourceChart.status.resource.version}"
              sourceRef:
                kind: HelmRepository
                name: ${schema.metadata.name}
          values: |
            ${schema.spec.values}
