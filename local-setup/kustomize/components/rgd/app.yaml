apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: app
spec:
  schema:
    apiVersion: v1alpha1
    kind: App
    spec:
      values: string
      resourcePath: string | required=true
      targetNamespace: string | required=true default="openmfp-system"
      driftDetectionMode: string | required=true default="enabled"
      createNamespace: boolean | required=true default="false"
      secretName: string | required=true default="openmfp-system"
      componentName: string | required=true default="openmfp-priv"
  resources:
    - id: resourceChart
      template:
        apiVersion: delivery.ocm.software/v1alpha1
        kind: Resource
        metadata:
          name: ${schema.metadata.name}
        spec:
          componentRef:
            name: ${schema.spec.componentName}
          resource:
            byReference:
              resource:
                name: chart
              referencePath:
                - name: ${schema.spec.resourcePath}
          interval: 1m
          ocmConfig:
            - kind: Secret
              name: ${schema.spec.secretName}
    - id: ocirepository
      template:
        apiVersion: source.toolkit.fluxcd.io/v1beta2
        kind: OCIRepository
        metadata:
          name: ${schema.metadata.name}
        spec:
          interval: 1m0s
          layerSelector:
            mediaType: "application/vnd.cncf.helm.chart.content.v1.tar+gzip"
            operation: copy
          url: oci://${resourceChart.status.reference.registry}/${resourceChart.status.reference.repository}
          ref:
            tag: ${resourceChart.status.reference.tag}
          secretRef:
            name: github
#    # HelmRelease refers to the OCIRepository, lets you configure the helm chart and deploys the Helm Chart into the
#    # Kubernetes cluster.
#    - id: helmrelease
#      template:
#        apiVersion: helm.toolkit.fluxcd.io/v2
#        kind: HelmRelease
#        metadata:
#          name: ${schema.metadata.name}
#        spec:
#          releaseName: ${schema.metadata.name}
#          interval: 1m
#          timeout: 5m
#          chartRef:
#            kind: OCIRepository
#            name: ${ocirepository.metadata.name}
#            namespace: default
#          values: |
#            ${schema.spec.values}
